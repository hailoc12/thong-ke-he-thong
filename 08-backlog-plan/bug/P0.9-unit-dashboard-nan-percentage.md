# Bug: NaN% displayed on Unit Dashboard

**Priority:** P0
**Status:** To Do
**Reported:** 2026-01-20
**Component:** UnitDashboard.tsx
**Affects:** Unit Dashboard statistics cards

## Problem Description

User reported seeing "NaN%" displayed on the Unit Dashboard, specifically mentioning "Tỷ lệ quan trọng NaN%" (Important ratio showing NaN%).

## Location

**File:** `/frontend/src/pages/UnitDashboard.tsx`

## Possible Causes

1. **Division by zero**: If `total_systems` is 0, calculating `overall_completion_percentage` might result in NaN
2. **Invalid data**: Backend returning null/undefined values in calculation
3. **Frontend calculation error**: CountUp component receiving invalid number
4. **API response issue**: Missing or malformed data from `/api/systems/dashboard/unit-progress/`

## Investigation Steps

1. ✅ Check UnitDashboard.tsx calculation logic
2. ✅ Verify backend views.py calculation
3. ⏭️ Test with organization that has 0 systems
4. ⏭️ Test with organization that has systems with 0% completion
5. ⏭️ Check browser console for errors
6. ✅ Review CountUp component usage

## Root Cause Found (2026-01-20)

**Issue:** Color token objects used instead of strings in multiple locations:

1. **Line 241:** `colors.success` → Fixed to `colors.success.main`
2. **Line 267:** `colors.warning` → Fixed to `colors.warning.main`
3. **Lines 124, 126, 128, 129:** Progress bar `strokeColor` using objects → Fixed to `.main` properties

**Impact:** Using objects in CSS/component props can cause:
- CSS gradient rendering as `[object Object]`
- Progress bar color issues
- Potential NaN display when components try to parse objects

**Fix Applied:**
- All color references now use `.main` property (string values)
- Build successful after fix
- Ready for testing

## Expected Behavior

- If organization has 0 systems → Display "0%" or "N/A", not "NaN%"
- If all systems have 0% completion → Display "0%"
- All statistics should display valid percentages or fallback values

## Related Code Sections

### UnitDashboard.tsx (Lines to Check)

**Statistics Cards:**
```typescript
// Line 221 - Total Systems
<CountUp end={dashboardData?.total_systems || 0} duration={1.5} />

// Line 246 - Overall Completion Percentage
<CountUp end={dashboardData?.overall_completion_percentage || 0} decimals={1} duration={1.5} />

// Line 273 - Incomplete Systems
<CountUp end={dashboardData?.incomplete_systems || 0} duration={1.5} />
```

**Backend Calculation (views.py:203-297):**
```python
# Line 286
overall_completion_percentage = round(total_completion / total_systems, 1) if total_systems > 0 else 0.0
```

## Fix Strategy

1. Add null/undefined checks in frontend
2. Ensure backend always returns valid numbers (not NaN/Infinity)
3. Add fallback values in CountUp component
4. Test edge cases: 0 systems, 0% completion, null data

## Acceptance Criteria

- [ ] Dashboard displays "0%" instead of "NaN%" when appropriate
- [ ] No console errors related to NaN calculations
- [ ] All three statistics cards show valid numbers or "N/A"
- [ ] Works correctly with 0 systems
- [ ] Works correctly with null/undefined data

## Test Cases

1. Organization with 0 systems
2. Organization with 1 system at 0% completion
3. Organization with multiple systems at various completion levels
4. Backend returns null/undefined values
5. Backend returns empty array

---

**Notes:** User specifically mentioned "Tỷ lệ quan trọng" which likely refers to one of the three statistics cards. Need to identify which one and fix the calculation.
