# P0.8 Phase 1 Deployment Guide

**Date:** 2026-01-19
**Phase:** Phase 1 - Critical Gaps (P0 Blockers)
**Status:** READY FOR DEPLOYMENT
**Deployment Type:** Docker Compose

---

## Quick Start

### Automated Deployment (Recommended)

```bash
# Navigate to project root
cd /Users/shimazu/Dropbox/9.\ active/consultant/support_b4t/thong_ke_he_thong

# Run deployment script
./deploy-phase1.sh
```

The script will:
1. ✅ Check Docker installation
2. ✅ Backup database
3. ✅ Stop existing services
4. ✅ Build new images
5. ✅ Start services
6. ✅ Wait for health checks
7. ✅ Verify migration applied
8. ✅ Run smoke tests
9. ✅ Display summary

**Estimated Time:** 5-10 minutes

---

## Manual Deployment Steps

If you prefer manual control or troubleshooting:

### Step 1: Prerequisites Check

```bash
# Check Docker is installed and running
docker --version
# Expected: Docker version 20.x or higher

docker compose version
# Expected: Docker Compose version v2.x or higher

# Check Docker daemon is running
docker info
# Should return system info without errors
```

**If Docker is not installed:**
- macOS: Download Docker Desktop from https://www.docker.com/products/docker-desktop
- Linux: `sudo apt-get install docker.io docker-compose`
- Windows: Download Docker Desktop for Windows

### Step 2: Backup Database (CRITICAL)

```bash
cd /Users/shimazu/Dropbox/9.\ active/consultant/support_b4t/thong_ke_he_thong

# Create backup directory
mkdir -p backups/phase1-$(date +%Y%m%d-%H%M%S)

# Backup database (if postgres is running)
docker compose exec -T postgres pg_dump -U postgres system_reports > backups/phase1-$(date +%Y%m%d-%H%M%S)/database.sql

# Verify backup file exists and has content
ls -lh backups/phase1-*/database.sql
```

**Why backup?**
- Phase 1 includes data migration (system_group value changes)
- If something goes wrong, you can restore
- Database backup is your safety net

### Step 3: Stop Existing Services

```bash
# Check what's currently running
docker compose ps

# Stop all services
docker compose down

# Verify stopped
docker compose ps
# Should show no containers or "No containers"
```

### Step 4: Build New Images

```bash
# Build backend with new migration and models
docker compose build backend

# Build frontend with new forms
docker compose build frontend

# Verify images created
docker images | grep thong_ke_he_thong
```

**Expected Output:**
```
thong_ke_he_thong-backend    latest    <image_id>   <time_ago>   <size>
thong_ke_he_thong-frontend   latest    <image_id>   <time_ago>   <size>
```

### Step 5: Start Services

```bash
# Start all services in background
docker compose up -d

# Check status
docker compose ps
```

**Expected Status:**
```
NAME                         STATUS          PORTS
thong_ke_he_thong-postgres   Up (healthy)    5432/tcp
thong_ke_he_thong-backend    Up (healthy)    0.0.0.0:8000->8000/tcp
thong_ke_he_thong-frontend   Up (healthy)    0.0.0.0:3000->80/tcp
```

### Step 6: Monitor Migration

```bash
# Watch backend logs for migration
docker compose logs -f backend

# Look for these lines:
# "Applying systems.0004_p08_phase1_all_changes..."
# "✓ Migrated X systems from 'platform' to 'shared_platform'"
# "✓ Migrated X systems from 'business' to 'business_app'"
# "✓ Set default 'other' for X systems with empty system_group"
# "✓ Set default 'internal_unit' for X systems with empty scope"
# "Applying systems.0004_p08_phase1_all_changes... OK"

# Press Ctrl+C to stop following logs
```

### Step 7: Verify Services are Healthy

```bash
# Wait for services to be healthy (may take 30-60 seconds)
watch docker compose ps
# Wait until all show "Up (healthy)"

# Or check manually:
curl http://localhost:8000/api/
# Expected: {"message": "System Reports API"}

curl http://localhost:3000/
# Expected: HTML content (200 OK)
```

### Step 8: Verify Migration Applied

```bash
# Check Django migrations table
docker compose exec postgres psql -U postgres -d system_reports -c \
  "SELECT * FROM django_migrations WHERE name = '0004_p08_phase1_all_changes';"

# Expected: One row showing the migration was applied
```

### Step 9: Verify Database Schema

```bash
# Check SystemIntegrationConnection table exists
docker compose exec postgres psql -U postgres -d system_reports -c "\d system_integration_connections"

# Expected: Table structure with columns:
# - id, system_id, source_system, target_system, data_objects
# - integration_method, frequency, error_handling, has_api_docs
# - notes, created_at, updated_at

# Check scope and system_group are NOT NULL
docker compose exec postgres psql -U postgres -d system_reports -c \
  "SELECT COUNT(*) FROM systems_system WHERE scope IS NULL OR system_group IS NULL;"

# Expected: count = 0
```

### Step 10: Run Smoke Tests

```bash
# Test 1: Backend API
curl -f http://localhost:8000/api/ && echo " ✓ Backend OK"

# Test 2: Frontend
curl -f http://localhost:3000/ && echo " ✓ Frontend OK"

# Test 3: Check data migration worked
docker compose exec postgres psql -U postgres -d system_reports -c \
  "SELECT system_code, system_name, system_group, scope FROM systems_system LIMIT 5;"

# Verify:
# - No NULL values in scope or system_group
# - system_group has valid values (8 options)
# - Old values migrated: platform→shared_platform, business→business_app
```

---

## Post-Deployment Verification

### Access the Application

```bash
# Open in browser
open http://localhost:3000

# Or manually navigate to:
# Frontend: http://localhost:3000
# Backend API: http://localhost:8000/api/
```

### Login and Test

1. **Login** as admin or org_admin
2. **Navigate** to "Tạo hệ thống mới" (Create System)
3. **Verify Phase 1 fields are present:**

   **Section 1 (Thông tin tổng quan):**
   - [ ] Phạm vi sử dụng (scope) - REQUIRED field with 3 options
   - [ ] Nhóm hệ thống (system_group) - REQUIRED field with 8 options

   **Section 2 (Thông tin tổng quan):**
   - [ ] Tổng số tài khoản (total_accounts)
   - [ ] MAU (Monthly Active Users)
   - [ ] DAU (Daily Active Users)
   - [ ] Số đơn vị/địa phương (num_organizations)

   **Section 4 (CSDL & Mô hình dữ liệu):**
   - [ ] Dung lượng CSDL hiện tại (GB) (storage_size_gb)
   - [ ] Dung lượng file đính kèm (GB) (file_storage_size_gb)
   - [ ] Tốc độ tăng trưởng dữ liệu (%) (growth_rate_percent)

   **Section 5 (Tích hợp hệ thống):**
   - [ ] Số API cung cấp (api_provided_count)
   - [ ] Số API tiêu thụ (api_consumed_count)
   - [ ] Danh sách kết nối tích hợp chi tiết (integration_connections_data)

4. **Test Create Flow:**
   - Fill all required fields
   - Add 2-3 integration connections
   - Save system
   - Verify no errors

5. **Test Edit Flow:**
   - Open the system you just created
   - Verify all fields loaded correctly
   - Edit an integration connection
   - Delete an integration connection
   - Add a new integration connection
   - Save changes
   - Verify persisted correctly

### Quick Validation Tests

```bash
# Test 1: Create a system via API
curl -X POST http://localhost:8000/api/systems/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your_token>" \
  -d '{
    "system_name": "Test Phase 1",
    "scope": "internal_unit",
    "system_group": "business_app",
    "org": 1
  }'

# Test 2: Query systems with new fields
docker compose exec postgres psql -U postgres -d system_reports -c \
  "SELECT system_code, scope, system_group, total_accounts FROM systems_system LIMIT 3;"

# Test 3: Check integration connections
docker compose exec postgres psql -U postgres -d system_reports -c \
  "SELECT COUNT(*) FROM system_integration_connections;"
```

---

## Monitoring and Logs

### View Live Logs

```bash
# All services
docker compose logs -f

# Backend only
docker compose logs -f backend

# Frontend only
docker compose logs -f frontend

# Postgres only
docker compose logs -f postgres

# Last 100 lines
docker compose logs --tail=100 backend
```

### Check Service Status

```bash
# Overview
docker compose ps

# Detailed stats
docker stats
```

### Database CLI Access

```bash
# Connect to postgres
docker compose exec postgres psql -U postgres -d system_reports

# Once connected, run queries:
# \dt - list tables
# \d systems_system - describe table
# SELECT * FROM django_migrations ORDER BY applied DESC LIMIT 5;
# \q - quit
```

---

## Troubleshooting

### Issue: Migration Not Applied

**Symptoms:**
- Backend logs show "No migrations to apply"
- Phase 1 fields missing in database

**Diagnosis:**
```bash
docker compose exec backend python manage.py showmigrations systems
```

**Solution:**
```bash
# Run migration manually
docker compose exec backend python manage.py migrate systems 0004_p08_phase1_all_changes

# Check logs
docker compose logs backend
```

### Issue: Services Not Healthy

**Symptoms:**
- `docker compose ps` shows "unhealthy"

**Diagnosis:**
```bash
# Check health check logs
docker inspect thong_ke_he_thong-backend --format='{{json .State.Health}}' | jq
```

**Solutions:**

**Backend unhealthy:**
```bash
# Check logs
docker compose logs backend

# Common issues:
# - Database connection failed → Check postgres is healthy
# - Port 8000 already in use → Stop other services using port 8000
# - Migration error → Check migration logs

# Restart backend
docker compose restart backend
```

**Frontend unhealthy:**
```bash
# Check logs
docker compose logs frontend

# Common issues:
# - Build failed → Rebuild: docker compose build frontend
# - Port 3000 in use → Stop other services
# - Backend not reachable → Check backend is healthy

# Restart frontend
docker compose restart frontend
```

**Postgres unhealthy:**
```bash
# Check logs
docker compose logs postgres

# Common issues:
# - Port 5432 in use → Stop other postgres instances
# - Volume mount issues → Check disk space
# - Init script errors → Check initialization logs

# Restart postgres (WARNING: may lose data)
docker compose restart postgres
```

### Issue: Build Errors

**Symptoms:**
- `docker compose build` fails

**Backend build failure:**
```bash
# Check Dockerfile
cat backend/Dockerfile

# Common issues:
# - requirements.txt missing packages
# - Python version incompatibility
# - Missing files

# Clean build
docker compose build --no-cache backend
```

**Frontend build failure:**
```bash
# Check Dockerfile
cat frontend/Dockerfile

# Common issues:
# - npm install fails
# - TypeScript compilation errors
# - Missing dependencies

# Clean build
docker compose build --no-cache frontend
```

### Issue: Data Migration Errors

**Symptoms:**
- Migration runs but data not migrated correctly
- NULL values in scope/system_group

**Diagnosis:**
```bash
# Check for NULL values
docker compose exec postgres psql -U postgres -d system_reports -c \
  "SELECT id, system_code, scope, system_group FROM systems_system WHERE scope IS NULL OR system_group IS NULL;"
```

**Solution:**
```bash
# Rollback migration
docker compose exec backend python manage.py migrate systems 0002

# Restore database from backup
docker compose exec -T postgres psql -U postgres -d system_reports < backups/phase1-<timestamp>/database.sql

# Re-run migration
docker compose exec backend python manage.py migrate systems 0004_p08_phase1_all_changes
```

### Issue: Port Conflicts

**Symptoms:**
- Error: "port is already allocated"

**Solution:**
```bash
# Check what's using the ports
lsof -i :3000  # Frontend
lsof -i :8000  # Backend
lsof -i :5432  # Postgres

# Kill conflicting process
kill -9 <PID>

# Or change ports in docker-compose.yml
```

### Issue: Frontend Can't Reach Backend

**Symptoms:**
- Frontend loads but API calls fail
- Browser console: "Network Error"

**Diagnosis:**
```bash
# Check backend is accessible from host
curl http://localhost:8000/api/

# Check from frontend container
docker compose exec frontend wget -O- http://backend:8000/api/
```

**Solution:**
```bash
# Check frontend environment variables
docker compose exec frontend env | grep API

# Restart both services
docker compose restart backend frontend
```

---

## Rollback Procedures

### Level 1: Rollback Migration Only (Keep Code)

```bash
# Rollback to previous migration
docker compose exec backend python manage.py migrate systems 0002_add_p08_fields

# Restart backend
docker compose restart backend
```

**When to use:**
- Migration caused data issues
- Want to fix migration and re-apply
- Code changes are fine

### Level 2: Full Rollback (Code + Database)

```bash
# Stop services
docker compose down

# Restore database
docker compose up -d postgres
docker compose exec -T postgres psql -U postgres -d system_reports < backups/phase1-<timestamp>/database.sql

# Checkout previous code
git log --oneline -10  # Find commit before Phase 1
git checkout <previous_commit_hash>

# Rebuild and restart
docker compose build
docker compose up -d
```

**When to use:**
- Critical bug found
- Cannot fix quickly
- Need to revert everything

### Level 3: Emergency Shutdown

```bash
# Stop all services immediately
docker compose down

# Remove containers and volumes (WARNING: DATA LOSS)
docker compose down -v
```

**When to use:**
- System compromised
- Data corruption detected
- Emergency only

---

## Performance Benchmarks

After deployment, verify performance:

### Page Load Time

```bash
# Measure frontend initial load
curl -o /dev/null -s -w "Time: %{time_total}s\n" http://localhost:3000/

# Expected: < 3 seconds
```

### API Response Time

```bash
# Measure API response
curl -o /dev/null -s -w "Time: %{time_total}s\n" http://localhost:8000/api/systems/

# Expected: < 1 second
```

### Database Query Time

```bash
# Measure query performance
docker compose exec postgres psql -U postgres -d system_reports -c \
  "EXPLAIN ANALYZE SELECT * FROM systems_system WHERE scope = 'internal_unit' LIMIT 10;"

# Expected: < 100ms
```

---

## Security Checklist

Post-deployment security verification:

- [ ] Change default database password in production
- [ ] Ensure HTTPS enabled (if production)
- [ ] Check CORS settings in backend
- [ ] Verify JWT secret is secure
- [ ] Confirm debug mode is OFF (if production)
- [ ] Review file upload permissions
- [ ] Check API rate limiting
- [ ] Verify user authentication works

---

## Success Criteria

Deployment is successful when:

- [ ] All 3 services show "Up (healthy)" status
- [ ] Migration 0004_p08_phase1_all_changes applied
- [ ] No NULL values in scope/system_group fields
- [ ] SystemIntegrationConnection table exists
- [ ] Frontend accessible at http://localhost:3000
- [ ] Backend API accessible at http://localhost:8000
- [ ] All 10 Phase 1 fields visible in UI
- [ ] Can create system with new fields
- [ ] Can edit system and fields persist
- [ ] IntegrationConnectionList CRUD works
- [ ] No errors in browser console
- [ ] No errors in Docker logs

---

## Next Steps After Successful Deployment

1. **Run Full Testing:**
   - Follow P0.8-PHASE1-TESTING-GUIDE.md
   - Complete all 60+ test cases
   - Document any issues found

2. **Performance Testing:**
   - Load test with 100+ systems
   - Test with 10+ integration connections per system
   - Monitor memory usage

3. **User Acceptance Testing (UAT):**
   - Schedule demo with customer
   - Walk through all new fields
   - Get feedback on IntegrationConnectionList UX
   - Document change requests

4. **Update Documentation:**
   - Update user manual with Phase 1 fields
   - Create video tutorials for new features
   - Update API documentation

5. **Plan Phase 2:**
   - Review customer feedback from Phase 1
   - Prioritize Phase 2 tasks
   - Create detailed Phase 2 task breakdown
   - Estimate timeline

---

## Useful Commands Reference

```bash
# Start services
docker compose up -d

# Stop services
docker compose down

# Restart service
docker compose restart backend

# View logs
docker compose logs -f backend

# Rebuild service
docker compose build backend

# Execute command in container
docker compose exec backend python manage.py shell

# Database backup
docker compose exec -T postgres pg_dump -U postgres system_reports > backup.sql

# Database restore
docker compose exec -T postgres psql -U postgres -d system_reports < backup.sql

# Check service status
docker compose ps

# View resource usage
docker stats

# Clean up unused images
docker system prune -a

# Check migration status
docker compose exec backend python manage.py showmigrations

# Create superuser
docker compose exec backend python manage.py createsuperuser

# Collect static files
docker compose exec backend python manage.py collectstatic --noinput
```

---

## Support and Contact

**Issues?**
- Check troubleshooting section above
- Review logs: `docker compose logs`
- Check testing guide: P0.8-PHASE1-TESTING-GUIDE.md

**Documentation:**
- Implementation Summary: P0.8-PHASE1-IMPLEMENTATION-SUMMARY.md
- Testing Guide: P0.8-PHASE1-TESTING-GUIDE.md
- Task Breakdown: P0.8-PHASE1-critical-gaps.md
- Master Overview: P0.8-MASTER-OVERVIEW.md

---

**Deployment Guide Version:** 1.0
**Last Updated:** 2026-01-19
**Phase:** Phase 1 - Critical Gaps (P0 Blockers)
**Status:** READY FOR DEPLOYMENT
