# P0.8 Phase 1 Testing Guide

**Date:** 2026-01-19
**Status:** READY FOR TESTING
**Phase:** Phase 1 - Critical Gaps (P0 Blockers)
**Backend Status:** ✅ Migration ready (0004_p08_phase1_all_changes.py)
**Frontend Status:** ✅ Build successful (dist/ ready)

---

## Pre-Testing Validation

### ✅ Code Quality Checks (COMPLETED)

- [x] Migration file syntax validated (Python 3.14)
- [x] Frontend TypeScript build successful
- [x] All Phase 1 fields implemented in models
- [x] All Phase 1 fields implemented in forms
- [x] Serializers updated with nested writes
- [x] IntegrationConnectionList component created

### Build Output
```
✓ vite v7.3.1 building client environment for production...
✓ 6756 modules transformed
✓ dist/index.html                     0.50 kB │ gzip:     0.34 kB
✓ dist/assets/index-O0LfCPER.css     15.80 kB │ gzip:     3.89 kB
✓ dist/assets/index-gtmJBkVg.js   3,811.43 kB │ gzip: 1,129.06 kB
✓ built in 11.26s
```

---

## Environment Setup

### Start Docker Environment

```bash
# Navigate to project root
cd /Users/shimazu/Dropbox/9.\ active/consultant/support_b4t/thong_ke_he_thong

# Start all services (postgres, backend, frontend)
docker compose up -d

# Wait for services to be healthy (~60 seconds)
docker compose ps

# Check logs for migration completion
docker compose logs backend | grep "Applying systems.0004"
```

### Expected Migration Output

```
✓ Migrated X systems from 'platform' to 'shared_platform'
✓ Migrated X systems from 'business' to 'business_app'
✓ Migrated X systems from 'website' to 'portal'
✓ Set default 'other' for X systems with empty system_group
✓ Set default 'internal_unit' for X systems with empty scope
Applying systems.0004_p08_phase1_all_changes... OK
```

### Verify Services Running

```bash
# Backend health check
curl http://localhost:8000/api/
# Expected: {"message": "System Reports API"}

# Frontend health check
curl http://localhost:3000/
# Expected: 200 OK with HTML content

# Database connection
docker compose exec postgres psql -U postgres -d system_reports -c "\dt"
# Expected: List of tables including system_integration_connections
```

---

## Testing Checklist

### Section 1: Required Fields (System Group & Scope)

#### Test 1.1: Create System - Required Field Validation

**Steps:**
1. Navigate to http://localhost:3000
2. Login as admin or org_admin
3. Click "Tạo hệ thống mới" (Create System)
4. Leave "Phạm vi sử dụng" (scope) empty
5. Leave "Nhóm hệ thống" (system_group) empty
6. Try to submit form

**Expected Result:**
- ❌ Form validation fails
- Error message: "Vui lòng chọn phạm vi sử dụng"
- Error message: "Vui lòng chọn nhóm hệ thống"

#### Test 1.2: Scope Field Options

**Steps:**
1. Click on "Phạm vi sử dụng" dropdown

**Expected Options:**
- Nội bộ đơn vị (internal_unit)
- Toàn bộ (org_wide)
- Bên ngoài (external)

**Default Value:** "Nội bộ đơn vị" should be pre-selected

#### Test 1.3: System Group Field Options (8 options per customer feedback)

**Steps:**
1. Click on "Nhóm hệ thống" dropdown

**Expected Options (in order):**
1. Nền tảng quốc gia (national_platform)
2. Nền tảng dùng chung của Bộ (shared_platform)
3. CSDL chuyên ngành (specialized_db)
4. Ứng dụng nghiệp vụ (business_app)
5. Cổng thông tin (portal)
6. BI/Báo cáo (bi)
7. ESB/Tích hợp (esb)
8. Khác (other)

**Default Value:** "Khác" should be pre-selected

#### Test 1.4: Data Migration Verification

**Steps:**
1. Check existing systems in database

```sql
docker compose exec postgres psql -U postgres -d system_reports

-- Check if old values were migrated
SELECT system_code, system_name, system_group, scope
FROM systems_system
WHERE system_group IN ('shared_platform', 'business_app', 'portal');

-- Verify no NULL or empty values
SELECT COUNT(*) FROM systems_system WHERE system_group IS NULL OR system_group = '';
-- Expected: 0

SELECT COUNT(*) FROM systems_system WHERE scope IS NULL OR scope = '';
-- Expected: 0
```

**Expected Result:**
- All existing systems have valid system_group values
- All existing systems have valid scope values (default: 'internal_unit')
- Old values migrated: platform→shared_platform, business→business_app, website→portal

---

### Section 2: User Metrics Fields

#### Test 2.1: Total Accounts Field

**Steps:**
1. Scroll to "Thông tin tổng quan" section
2. Find "Tổng số tài khoản" (total_accounts) field
3. Enter value: 12500
4. Verify number formatting (comma separators)

**Expected:**
- Field accepts integers only
- Minimum value: 0
- Value formatted as: 12,500
- Tooltip: "P0.8 Phase 1: Tổng số tài khoản đã tạo trong hệ thống"

#### Test 2.2: MAU (Monthly Active Users)

**Steps:**
1. Find "MAU (Monthly Active Users)" field
2. Enter value: 8000
3. Verify formatting

**Expected:**
- Field accepts integers only
- Minimum value: 0
- Value formatted as: 8,000

#### Test 2.3: DAU (Daily Active Users)

**Steps:**
1. Find "DAU (Daily Active Users)" field
2. Enter value: 2500

**Expected:**
- Field accepts integers only
- Minimum value: 0
- Value formatted as: 2,500

#### Test 2.4: Number of Organizations

**Steps:**
1. Find "Số đơn vị/địa phương sử dụng" field
2. Enter value: 45

**Expected:**
- Field accepts integers only
- Minimum value: 0
- Tooltip: "Số đơn vị/địa phương sử dụng hệ thống"

#### Test 2.5: User Metrics Persistence

**Steps:**
1. Fill all 4 user metrics fields
2. Save system
3. Edit the system
4. Verify values are preserved

**Expected:**
- All 4 values saved correctly
- Values display with proper formatting on edit page

---

### Section 3: Data Volume Metrics (SystemDataInfo)

#### Test 3.1: Database Storage Size (GB)

**Steps:**
1. Navigate to "CSDL & Mô hình dữ liệu" tab
2. Find "Dung lượng CSDL hiện tại (GB)" field
3. Enter value: 125.5
4. Check tooltip

**Expected:**
- Field accepts decimal numbers (step: 0.1)
- Minimum value: 0
- Tooltip: "P0.8 Phase 1 - REQUIRED: Dung lượng cơ sở dữ liệu hiện tại"
- Placeholder: "Nhập dung lượng GB"

#### Test 3.2: File Storage Size (GB)

**Steps:**
1. Find "Dung lượng file đính kèm (GB)" field
2. Enter value: 45.8

**Expected:**
- Field accepts decimal numbers (step: 0.1)
- Minimum value: 0
- Tooltip: "P0.8 Phase 1: Dung lượng file đính kèm, tài liệu lưu trữ"

#### Test 3.3: Growth Rate Percent

**Steps:**
1. Find "Tốc độ tăng trưởng dữ liệu (%)" field
2. Enter value: 15.5
3. Verify percentage formatting

**Expected:**
- Field accepts decimal numbers (0-100)
- Step: 0.1
- Display format: "15.5%" (with % symbol)
- Input allows typing numbers without %
- Tooltip: "P0.8 Phase 1: Tốc độ tăng trưởng dữ liệu (%/năm hoặc GB/tháng)"

#### Test 3.4: Negative Value Validation

**Steps:**
1. Try to enter negative values in each field
2. Try to enter values > 100 for growth_rate_percent

**Expected:**
- storage_size_gb: Cannot enter negative
- file_storage_size_gb: Cannot enter negative
- growth_rate_percent: Cannot enter > 100 or negative

---

### Section 4: API Inventory Fields

#### Test 4.1: APIs Provided Count

**Steps:**
1. Navigate to "Tích hợp hệ thống" tab
2. Find "Số API cung cấp" (api_provided_count) field
3. Enter value: 12

**Expected:**
- Field accepts integers only
- Minimum value: 0
- Value formatted as: 12
- Tooltip: "Tổng số API mà hệ thống này cung cấp cho hệ thống khác"

#### Test 4.2: APIs Consumed Count

**Steps:**
1. Find "Số API tiêu thụ" (api_consumed_count) field
2. Enter value: 8

**Expected:**
- Field accepts integers only
- Minimum value: 0
- Value formatted as: 8
- Tooltip: "Tổng số API mà hệ thống này gọi từ hệ thống khác"

---

### Section 5: Integration Connections (Complex Dynamic Form)

#### Test 5.1: Add New Integration Connection

**Steps:**
1. Scroll to "Danh sách kết nối tích hợp chi tiết" section
2. Click "Thêm kết nối" (Add Connection) button
3. Fill form:
   - **Hệ thống nguồn:** HRM System
   - **Hệ thống đích:** Payroll System
   - **Đối tượng dữ liệu:** Thông tin nhân viên, phòng ban, chức vụ, lương
   - **Phương thức tích hợp:** API REST
   - **Tần suất:** Batch - Hàng ngày
   - **Error Handling:** Retry 3 lần, delay 5 phút, email notification
   - **Has API Documentation:** Yes (checked)
   - **Notes:** Integration được thiết kế cho đồng bộ lương
4. Click "Lưu" (Save)

**Expected:**
- Form validation passes (source_system, target_system, data_objects, integration_method, frequency are required)
- New card appears in list showing:
  - "HRM System → Payroll System"
  - Integration method badge: "API REST"
  - Frequency badge: "Batch - Hàng ngày"
  - Green checkmark for API docs
  - Data objects displayed
  - Notes displayed
- Form closes
- "Thêm kết nối" button remains visible

#### Test 5.2: Validation - Required Fields

**Steps:**
1. Click "Thêm kết nối"
2. Leave "Hệ thống nguồn" empty
3. Try to save

**Expected:**
- Error message: "Vui lòng nhập hệ thống nguồn"

**Repeat for:**
- Hệ thống đích
- Đối tượng dữ liệu
- Phương thức tích hợp
- Tần suất

#### Test 5.3: Integration Method Options

**Steps:**
1. Click "Phương thức tích hợp" dropdown

**Expected Options (8 total):**
1. API REST (api_rest)
2. API SOAP (api_soap)
3. API GraphQL (api_graphql)
4. File Transfer (file_transfer)
5. Database Link (database_link)
6. Message Queue (message_queue)
7. Thủ công (manual)
8. Khác (other)

#### Test 5.4: Frequency Options

**Steps:**
1. Click "Tần suất" dropdown

**Expected Options (7 total):**
1. Real-time (realtime)
2. Near real-time (< 1 phút) (near_realtime)
3. Batch - Mỗi giờ (batch_hourly)
4. Batch - Hàng ngày (batch_daily)
5. Batch - Hàng tuần (batch_weekly)
6. Batch - Hàng tháng (batch_monthly)
7. On-demand (on_demand)

#### Test 5.5: Edit Existing Connection

**Steps:**
1. Add a connection (see Test 5.1)
2. Click "Sửa" (Edit) button on the card
3. Change "Hệ thống đích" to "Finance System"
4. Change "Phương thức tích hợp" to "API SOAP"
5. Click "Lưu"

**Expected:**
- Form switches to inline edit mode
- Values pre-filled correctly
- After save:
  - Card updates with new values
  - "HRM System → Finance System"
  - Method badge: "API SOAP"

#### Test 5.6: Cancel Edit

**Steps:**
1. Edit a connection
2. Change some values
3. Click "Hủy" (Cancel)

**Expected:**
- Changes discarded
- Card returns to view mode with original values

#### Test 5.7: Delete Connection

**Steps:**
1. Add 2 connections
2. Click "Xóa" (Delete) button on first connection
3. Confirm deletion

**Expected:**
- Confirmation modal appears: "Xác nhận xóa kết nối này?"
- After confirm:
  - First connection removed from list
  - Second connection remains
  - Array index updates correctly

#### Test 5.8: Multiple Connections Management

**Steps:**
1. Add 5 different connections
2. Edit the 3rd connection
3. Delete the 2nd connection
4. Save system
5. Edit system
6. Verify all connections

**Expected:**
- All 4 remaining connections saved to database
- Order preserved
- Edit page loads all connections correctly
- Each connection displays in separate card

#### Test 5.9: Connection Persistence in Database

**Steps:**
1. Create system with 3 integration connections
2. Check database:

```sql
docker compose exec postgres psql -U postgres -d system_reports

-- Find the system ID
SELECT id, system_code, system_name FROM systems_system
WHERE system_code = '[your_system_code]';

-- Check integration connections
SELECT
  id,
  source_system,
  target_system,
  integration_method,
  frequency,
  has_api_docs,
  created_at
FROM system_integration_connections
WHERE system_id = [system_id]
ORDER BY id;
```

**Expected:**
- 3 rows in system_integration_connections table
- Foreign key system_id correctly set
- All fields saved correctly
- created_at and updated_at timestamps set

---

## Cross-Browser Testing

Test on:
- [ ] Chrome (latest)
- [ ] Firefox (latest)
- [ ] Safari (latest)
- [ ] Edge (latest)

---

## Responsive Design Testing

Test on:
- [ ] Desktop (1920x1080)
- [ ] Laptop (1366x768)
- [ ] Tablet (iPad - 768x1024)
- [ ] Mobile (iPhone - 375x667)

**Key checks:**
- Form fields stack correctly on mobile
- IntegrationConnectionList cards responsive
- Tabs scrollable on mobile
- No horizontal overflow

---

## Performance Testing

### Load Time
```bash
# Measure page load
curl -o /dev/null -s -w "Total time: %{time_total}s\n" http://localhost:3000/systems/create
```

**Expected:** < 3 seconds

### Form Submission
1. Fill complete form with 10 integration connections
2. Submit
3. Measure time to save

**Expected:** < 5 seconds

---

## Error Scenarios

### Test E1: Network Error Handling

**Steps:**
1. Fill form completely
2. Stop backend: `docker compose stop backend`
3. Try to submit form

**Expected:**
- Error message displayed: "Không thể lưu hệ thống!"
- Form data NOT lost
- User can retry after backend restart

### Test E2: Invalid Data Type

**Steps:**
1. Use browser console to set invalid data:
```javascript
document.querySelector('[name="total_accounts"]').value = "abc";
```
2. Try to submit

**Expected:**
- Form validation catches invalid type
- Error message displayed

### Test E3: Concurrent Edit

**Steps:**
1. Open Edit page in 2 browser tabs
2. Edit different fields in each tab
3. Save Tab 1
4. Save Tab 2

**Expected:**
- Tab 2 overwrites Tab 1 (last write wins)
- OR: Show conflict warning (if implemented)

---

## Rollback Plan

If critical issues found:

### Backend Rollback
```bash
# Rollback migration
docker compose exec backend python manage.py migrate systems 0002_add_p08_fields

# Restart backend
docker compose restart backend
```

### Frontend Rollback
```bash
# Checkout previous commit
git checkout [previous_commit_hash] frontend/

# Rebuild
cd frontend && npm run build

# Rebuild Docker
docker compose build frontend
docker compose restart frontend
```

---

## Success Criteria

### All Tests Must Pass:
- [x] Migration runs without errors ✅
- [x] Frontend builds without TypeScript errors ✅
- [ ] All 10 P0 fields functional
- [ ] Section 1: scope & system_group REQUIRED validation works
- [ ] Section 2: 4 user metrics save/load correctly
- [ ] Section 4: 3 data volume fields save/load correctly
- [ ] Section 5: 2 API inventory counts functional
- [ ] Section 5: IntegrationConnectionList full CRUD works
- [ ] No console errors in browser
- [ ] No database constraint violations
- [ ] Data persists across create/edit cycles
- [ ] All existing systems migrated correctly

### Performance Criteria:
- [ ] Page load < 3 seconds
- [ ] Form submission < 5 seconds
- [ ] No memory leaks in IntegrationConnectionList component

---

## Known Issues (Track here)

### Issue #1: [Title]
- **Severity:** P0/P1/P2
- **Description:**
- **Steps to Reproduce:**
- **Expected:**
- **Actual:**
- **Workaround:**
- **Fix:**

---

## Testing Timeline

- **Setup:** 30 min
- **Section 1 Tests:** 45 min
- **Section 2 Tests:** 30 min
- **Section 3 Tests:** 30 min
- **Section 4 Tests:** 15 min
- **Section 5 Tests:** 90 min (complex dynamic form)
- **Cross-browser:** 45 min
- **Error scenarios:** 30 min
- **TOTAL:** ~5 hours

---

## Next Steps After Testing

1. ✅ **Testing Passes** → Update P0.8-PHASE1-critical-gaps.md status to "DONE"
2. ✅ **Testing Passes** → Move P0.8-PHASE1-critical-gaps.md to `08-backlog-plan/done/`
3. ✅ **Testing Passes** → Prepare Phase 2 planning document
4. ❌ **Testing Fails** → Log issues above, fix, re-test
5. ✅ **Production Ready** → Create deployment guide
6. ✅ **Deployed** → Get customer sign-off

---

**Testing Prepared By:** Vibe Coding Agent (Claude Code)
**Testing Date:** [To be filled by tester]
**Tester Name:** [To be filled]
**Overall Status:** [ ] PASS / [ ] FAIL
**Notes:** [Additional testing notes]
