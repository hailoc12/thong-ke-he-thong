# P0.8 - PHASE 1: Critical Gaps (P0 Blockers)

**Date:** 2026-01-19
**Status:** DOING
**Priority:** P0 - CRITICAL BLOCKERS
**Estimated Effort:** 21 hours (~3 days)
**Goal:** Fix all P0 blockers - missing REQUIRED fields that customer explicitly needs

---

## Overview

From Gap Analysis Report, we have **10 P0 critical items** that MUST be fixed before customer acceptance:

| # | Field | Section | Effort | Status |
|---|-------|---------|--------|--------|
| 1 | Phạm vi - Make REQUIRED | Section 1 | 2h | TODO |
| 2 | Nhóm hệ thống - Update 8 options | Section 1 | 2h | TODO |
| 3 | Tổng số tài khoản | Section 2 | 1h | TODO |
| 4 | MAU (Monthly Active Users) | Section 2 | 1h | TODO |
| 5 | DAU (Daily Active Users) | Section 2 | 1h | TODO |
| 6 | Số đơn vị/địa phương | Section 2 | 1h | TODO |
| 7 | Dung lượng DB hiện tại | Section 4 | 1h | TODO |
| 8 | Dung lượng file đính kèm | Section 4 | 3h | TODO |
| 9 | Tốc độ tăng trưởng | Section 4 | 1h | TODO |
| 10 | Danh sách tích hợp chi tiết | Section 5 | 8h | TODO |

---

## Task 1.1: Backend Migration - Section 1 Fields (2h)

**File:** `backend/apps/systems/migrations/000X_p08_phase1_section1.py`

### Changes Required:

#### 1.1.1 Make `scope` field REQUIRED (30 min)

**Current State:**
```python
# models.py line 53-58
scope = models.CharField(
    max_length=50,
    choices=SCOPE_CHOICES,
    blank=True,  # ← Currently OPTIONAL
    verbose_name='Phạm vi'
)
```

**Target State:**
```python
scope = models.CharField(
    max_length=50,
    choices=SCOPE_CHOICES,
    blank=False,  # ← Make REQUIRED
    null=False,
    verbose_name='Phạm vi'
)
```

**Migration Steps:**
- [ ] Update model field: `blank=False, null=False`
- [ ] Add data migration to set default 'organization' for existing null values
- [ ] Update form to show field as required

#### 1.1.2 Update `system_group` with 8 NEW options (1.5h)

**Current State (7 options):**
```python
# models.py line 14-22
GROUP_CHOICES = [
    ('platform', 'Nền tảng'),
    ('business', 'Ứng dụng nghiệp vụ'),
    ('portal', 'Cổng thông tin'),
    ('website', 'Website'),
    ('bi', 'BI/Báo cáo'),
    ('esb', 'ESB/Tích hợp'),
    ('other', 'Khác'),
]
```

**Target State (8 options per customer):**
```python
GROUP_CHOICES = [
    ('national_platform', 'Nền tảng quốc gia'),           # NEW
    ('shared_platform', 'Nền tảng dùng chung của Bộ'),   # RENAME from 'platform'
    ('specialized_db', 'CSDL chuyên ngành'),              # NEW
    ('business_app', 'Ứng dụng nghiệp vụ'),               # RENAME from 'business'
    ('portal', 'Cổng thông tin'),                         # KEEP
    ('bi', 'BI/Báo cáo'),                                  # KEEP
    ('esb', 'ESB/Tích hợp'),                              # KEEP
    ('other', 'Khác'),                                     # KEEP
]
```

**Migration Steps:**
- [ ] Update GROUP_CHOICES in models.py
- [ ] Create data migration:
  ```python
  def migrate_system_group(apps, schema_editor):
      System = apps.get_model('systems', 'System')
      mapping = {
          'platform': 'shared_platform',
          'business': 'business_app',
          # portal, bi, esb, other stay the same
      }
      for old_val, new_val in mapping.items():
          System.objects.filter(system_group=old_val).update(system_group=new_val)
  ```
- [ ] Make field REQUIRED: `blank=False, null=False`
- [ ] Add validation in model clean() method

**Acceptance Criteria:**
- [ ] Migration runs without errors
- [ ] Existing data migrated correctly
- [ ] Form shows 8 options with correct labels
- [ ] Both fields show as REQUIRED in form

---

## Task 1.2: Backend Models - Section 2 User Metrics (1h)

**Critical Finding:** These fields ALREADY EXIST in backend (line 260-263) but NOT in form!

### Fields Status:

```python
# backend/apps/systems/models.py line 260-263
users_mau = models.IntegerField(
    null=True,
    blank=True,
    verbose_name='MAU (Monthly Active Users)'
)
users_dau = models.IntegerField(
    null=True,
    blank=True,
    verbose_name='DAU (Daily Active Users)'
)
num_organizations = models.IntegerField(
    null=True,
    blank=True,
    verbose_name='Số đơn vị/địa phương sử dụng'
)
```

### Tasks:

#### 1.2.1 Add Missing Field: `total_accounts` (30 min)

```python
# Add to System model
total_accounts = models.IntegerField(
    null=True,
    blank=True,
    verbose_name='Tổng số tài khoản',
    help_text='Tổng số tài khoản đã tạo trong hệ thống'
)
```

**Steps:**
- [ ] Add field to System model
- [ ] Create migration
- [ ] Add to serializer
- [ ] Add to form (Section 2)

#### 1.2.2 Add fields to Form (30 min)

**NO backend changes needed** for MAU, DAU, num_organizations - they exist!

**Steps:**
- [ ] Add `total_accounts` field to SystemFormSection2.tsx (Line 296-327 area)
- [ ] Add `users_mau` field
- [ ] Add `users_dau` field
- [ ] Add `num_organizations` field
- [ ] All fields: Integer input with validation

**Acceptance Criteria:**
- [ ] total_accounts field added to backend model
- [ ] All 4 fields visible in Section 2 form
- [ ] Integer validation works
- [ ] Fields save correctly to API

---

## Task 1.3: Backend Models - Section 4 Data Volume (3h)

### 1.3.1 Add Field: `file_storage_size_gb` (1h)

**Current:** SystemDataInfo model exists but missing this field

**Add:**
```python
# backend/apps/systems/models.py - SystemDataInfo model
file_storage_size_gb = models.DecimalField(
    max_digits=10,
    decimal_places=2,
    null=True,
    blank=True,
    verbose_name='Dung lượng file đính kèm (GB)',
    help_text='Tổng dung lượng file đính kèm, tài liệu lưu trữ'
)
```

**Steps:**
- [ ] Add field to SystemDataInfo model
- [ ] Create migration
- [ ] Update SystemDataInfoSerializer
- [ ] Add to form Section 4

### 1.3.2 Expose Existing Fields in Form (1h)

**These fields EXIST in SystemDataInfo model (line 418-431) but NOT in form:**

```python
storage_size_gb = models.DecimalField(...)  # Line 418-424 - Dung lượng DB
growth_rate_percent = models.DecimalField(...)  # Line 425-431 - Tốc độ tăng trưởng
```

**Steps:**
- [ ] NO backend changes needed
- [ ] Add `storage_size_gb` to form (Section 4)
- [ ] Add `growth_rate_percent` to form (Section 4)
- [ ] Add `file_storage_size_gb` to form (Section 4)

### 1.3.3 Frontend Form - Section 4 Updates (1h)

**File:** `frontend/src/components/forms/SystemFormSection4.tsx`

**Add fields:**
```tsx
// Dung lượng DB hiện tại (REQUIRED per customer)
<Form.Item
  label="Dung lượng DB hiện tại (GB)"
  name="storage_size_gb"
  rules={[{ required: true, message: 'Vui lòng nhập dung lượng DB' }]}
>
  <InputNumber min={0} step={0.01} style={{ width: '100%' }} />
</Form.Item>

// Dung lượng file đính kèm (REQUIRED per customer)
<Form.Item
  label="Dung lượng file đính kèm (GB)"
  name="file_storage_size_gb"
  rules={[{ required: true, message: 'Vui lòng nhập dung lượng file' }]}
>
  <InputNumber min={0} step={0.01} style={{ width: '100%' }} />
</Form.Item>

// Tốc độ tăng trưởng (REQUIRED per customer)
<Form.Item
  label="Tốc độ tăng trưởng (%/năm hoặc GB/tháng)"
  name="growth_rate_percent"
  rules={[{ required: true, message: 'Vui lòng nhập tốc độ tăng trưởng' }]}
>
  <Input placeholder="VD: 10%/năm hoặc 5GB/tháng" />
</Form.Item>
```

**Acceptance Criteria:**
- [ ] file_storage_size_gb added to backend
- [ ] All 3 fields show in Section 4 form
- [ ] Fields marked as REQUIRED per customer feedback
- [ ] Numeric validation works
- [ ] Data saves correctly

---

## Task 1.4: Backend Models - Section 5 Integration Matrix (8h)

**This is the MOST COMPLEX P0 task** - requires new model and dynamic form.

### 1.4.1 Create New Model: SystemIntegrationConnection (2h)

**File:** `backend/apps/systems/models.py`

```python
class SystemIntegrationConnection(models.Model):
    """
    Danh sách tích hợp chi tiết - Dynamic list of integration connections
    Customer requirement: For each connection track:
    - Hệ thống A ↔ B
    - Dữ liệu trao đổi
    - Cách thức tích hợp
    - Tần suất
    - Xử lý lỗi/retry
    """
    system = models.ForeignKey(
        'System',
        on_delete=models.CASCADE,
        related_name='integration_connections',
        verbose_name='Hệ thống'
    )

    # Hệ thống kết nối (source → target)
    source_system = models.CharField(
        max_length=200,
        verbose_name='Hệ thống nguồn',
        help_text='Hệ thống cung cấp dữ liệu'
    )
    target_system = models.CharField(
        max_length=200,
        verbose_name='Hệ thống đích',
        help_text='Hệ thống nhận dữ liệu'
    )

    # Dữ liệu trao đổi
    data_objects = models.TextField(
        verbose_name='Dữ liệu trao đổi',
        help_text='Các đối tượng dữ liệu, entities được trao đổi'
    )

    # Cách thức tích hợp
    INTEGRATION_METHOD_CHOICES = [
        ('api_rest', 'API REST'),
        ('api_soap', 'API SOAP'),
        ('api_graphql', 'API GraphQL'),
        ('file_transfer', 'File Transfer'),
        ('database_link', 'Database Link'),
        ('message_queue', 'Message Queue'),
        ('manual', 'Thủ công'),
        ('other', 'Khác'),
    ]
    integration_method = models.CharField(
        max_length=50,
        choices=INTEGRATION_METHOD_CHOICES,
        verbose_name='Cách thức tích hợp'
    )

    # Tần suất
    FREQUENCY_CHOICES = [
        ('realtime', 'Real-time'),
        ('near_realtime', 'Near real-time (< 1 phút)'),
        ('batch_hourly', 'Batch - Mỗi giờ'),
        ('batch_daily', 'Batch - Hàng ngày'),
        ('batch_weekly', 'Batch - Hàng tuần'),
        ('batch_monthly', 'Batch - Hàng tháng'),
        ('on_demand', 'On-demand'),
    ]
    frequency = models.CharField(
        max_length=50,
        choices=FREQUENCY_CHOICES,
        verbose_name='Tần suất trao đổi'
    )

    # Xử lý lỗi
    error_handling = models.TextField(
        blank=True,
        verbose_name='Xử lý lỗi/Retry',
        help_text='Cơ chế retry, rollback, error notification'
    )

    # API documentation
    has_api_docs = models.BooleanField(
        default=False,
        verbose_name='Có tài liệu API?'
    )

    # Notes
    notes = models.TextField(
        blank=True,
        verbose_name='Ghi chú'
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Integration Connection'
        verbose_name_plural = 'Integration Connections'
        ordering = ['source_system', 'target_system']

    def __str__(self):
        return f"{self.source_system} → {self.target_system}"
```

**Steps:**
- [ ] Create model in models.py
- [ ] Create migration
- [ ] Add to admin.py as inline
- [ ] Create serializer

### 1.4.2 Create Serializer (1h)

**File:** `backend/apps/systems/serializers.py`

```python
class SystemIntegrationConnectionSerializer(serializers.ModelSerializer):
    class Meta:
        model = SystemIntegrationConnection
        fields = [
            'id',
            'source_system',
            'target_system',
            'data_objects',
            'integration_method',
            'frequency',
            'error_handling',
            'has_api_docs',
            'notes',
        ]

# Update SystemSerializer to include nested connections
class SystemSerializer(serializers.ModelSerializer):
    integration_connections = SystemIntegrationConnectionSerializer(
        many=True,
        required=False
    )

    class Meta:
        model = System
        fields = [
            # ... existing fields
            'integration_connections',  # Add this
        ]

    def create(self, validated_data):
        connections_data = validated_data.pop('integration_connections', [])
        system = super().create(validated_data)

        for conn_data in connections_data:
            SystemIntegrationConnection.objects.create(
                system=system,
                **conn_data
            )

        return system

    def update(self, instance, validated_data):
        connections_data = validated_data.pop('integration_connections', None)
        instance = super().update(instance, validated_data)

        if connections_data is not None:
            # Delete old connections and create new ones
            instance.integration_connections.all().delete()
            for conn_data in connections_data:
                SystemIntegrationConnection.objects.create(
                    system=instance,
                    **conn_data
                )

        return instance
```

**Steps:**
- [ ] Create serializer
- [ ] Add nested handling to SystemSerializer
- [ ] Test create with nested connections
- [ ] Test update with nested connections

### 1.4.3 Add API Inventory Fields (1h)

**Add to System model:**

```python
# backend/apps/systems/models.py - Add to System model
api_provided_count = models.IntegerField(
    null=True,
    blank=True,
    verbose_name='Số API cung cấp',
    help_text='Tổng số API mà hệ thống này cung cấp cho hệ thống khác'
)
api_consumed_count = models.IntegerField(
    null=True,
    blank=True,
    verbose_name='Số API tiêu thụ',
    help_text='Tổng số API mà hệ thống này gọi từ hệ thống khác'
)
```

**Steps:**
- [ ] Add fields to System model
- [ ] Create migration
- [ ] Add to serializer
- [ ] Add to form Section 5

### 1.4.4 Frontend Dynamic Form Component (4h)

**File:** `frontend/src/components/forms/IntegrationConnectionList.tsx`

Create reusable dynamic list component:

```tsx
import React from 'react';
import { Form, Input, Select, Button, Card, Space } from 'antd';
import { PlusOutlined, DeleteOutlined } from '@ant-design/icons';

const { TextArea } = Input;

const IntegrationConnectionList: React.FC = () => {
  return (
    <Form.List name="integration_connections">
      {(fields, { add, remove }) => (
        <>
          {fields.map((field, index) => (
            <Card
              key={field.key}
              title={`Kết nối tích hợp #${index + 1}`}
              extra={
                <Button
                  type="link"
                  danger
                  icon={<DeleteOutlined />}
                  onClick={() => remove(field.name)}
                >
                  Xóa
                </Button>
              }
              style={{ marginBottom: 16 }}
            >
              <Form.Item
                {...field}
                label="Hệ thống nguồn"
                name={[field.name, 'source_system']}
                rules={[{ required: true, message: 'Vui lòng nhập hệ thống nguồn' }]}
              >
                <Input placeholder="VD: Hệ thống quản lý nhân sự" />
              </Form.Item>

              <Form.Item
                {...field}
                label="Hệ thống đích"
                name={[field.name, 'target_system']}
                rules={[{ required: true, message: 'Vui lòng nhập hệ thống đích' }]}
              >
                <Input placeholder="VD: Hệ thống chấm công" />
              </Form.Item>

              <Form.Item
                {...field}
                label="Dữ liệu trao đổi"
                name={[field.name, 'data_objects']}
                rules={[{ required: true, message: 'Vui lòng mô tả dữ liệu' }]}
              >
                <TextArea
                  rows={2}
                  placeholder="VD: Thông tin nhân viên, phòng ban, chức vụ"
                />
              </Form.Item>

              <Form.Item
                {...field}
                label="Cách thức tích hợp"
                name={[field.name, 'integration_method']}
                rules={[{ required: true, message: 'Vui lòng chọn cách thức' }]}
              >
                <Select>
                  <Select.Option value="api_rest">API REST</Select.Option>
                  <Select.Option value="api_soap">API SOAP</Select.Option>
                  <Select.Option value="api_graphql">API GraphQL</Select.Option>
                  <Select.Option value="file_transfer">File Transfer</Select.Option>
                  <Select.Option value="database_link">Database Link</Select.Option>
                  <Select.Option value="message_queue">Message Queue</Select.Option>
                  <Select.Option value="manual">Thủ công</Select.Option>
                  <Select.Option value="other">Khác</Select.Option>
                </Select>
              </Form.Item>

              <Form.Item
                {...field}
                label="Tần suất"
                name={[field.name, 'frequency']}
                rules={[{ required: true, message: 'Vui lòng chọn tần suất' }]}
              >
                <Select>
                  <Select.Option value="realtime">Real-time</Select.Option>
                  <Select.Option value="near_realtime">Near real-time (&lt; 1 phút)</Select.Option>
                  <Select.Option value="batch_hourly">Batch - Mỗi giờ</Select.Option>
                  <Select.Option value="batch_daily">Batch - Hàng ngày</Select.Option>
                  <Select.Option value="batch_weekly">Batch - Hàng tuần</Select.Option>
                  <Select.Option value="batch_monthly">Batch - Hàng tháng</Select.Option>
                  <Select.Option value="on_demand">On-demand</Select.Option>
                </Select>
              </Form.Item>

              <Form.Item
                {...field}
                label="Xử lý lỗi/Retry"
                name={[field.name, 'error_handling']}
              >
                <TextArea
                  rows={2}
                  placeholder="VD: Retry 3 lần, delay 5 phút, gửi email cảnh báo"
                />
              </Form.Item>

              <Form.Item
                {...field}
                label="Có tài liệu API?"
                name={[field.name, 'has_api_docs']}
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>

              <Form.Item
                {...field}
                label="Ghi chú"
                name={[field.name, 'notes']}
              >
                <TextArea rows={2} />
              </Form.Item>
            </Card>
          ))}

          <Button
            type="dashed"
            onClick={() => add()}
            icon={<PlusOutlined />}
            block
          >
            Thêm kết nối tích hợp
          </Button>
        </>
      )}
    </Form.List>
  );
};

export default IntegrationConnectionList;
```

**Update SystemFormSection5.tsx:**

```tsx
// Add API Inventory fields
<Form.Item
  label="Tổng số API cung cấp"
  name="api_provided_count"
  tooltip="Số lượng API mà hệ thống này cung cấp cho hệ thống khác"
>
  <InputNumber min={0} style={{ width: '100%' }} />
</Form.Item>

<Form.Item
  label="Tổng số API tiêu thụ"
  name="api_consumed_count"
  tooltip="Số lượng API mà hệ thống này gọi từ hệ thống khác"
>
  <InputNumber min={0} style={{ width: '100%' }} />
</Form.Item>

<Divider>Danh sách tích hợp chi tiết</Divider>

<IntegrationConnectionList />
```

**Steps:**
- [ ] Create IntegrationConnectionList component
- [ ] Add to Section 5 form
- [ ] Add API inventory fields
- [ ] Test add/remove connections
- [ ] Test form submission with nested data
- [ ] Test edit with existing connections

**Acceptance Criteria:**
- [ ] Can add multiple integration connections
- [ ] Can remove connections
- [ ] All fields validate correctly
- [ ] Nested data saves to API
- [ ] Edit loads existing connections
- [ ] Delete connections works

---

## Phase 1 Summary

**Total Tasks:**
- Task 1.1: Backend Migration - Section 1 (2h)
- Task 1.2: Backend Models - Section 2 (1h)
- Task 1.3: Backend Models - Section 4 (3h)
- Task 1.4: Backend Models - Section 5 (8h)

**Total Effort:** 14 hours backend + 7 hours frontend = **21 hours**

**Critical Path:**
1. Section 1 migration (must run first) → 2h
2. Section 2, 4 migrations (parallel) → 3h
3. Section 5 complex model → 8h
4. Frontend forms for all sections → 7h
5. Testing → 1h

**Next Actions:**
1. Start with Task 1.1 (Section 1 migration)
2. Run migrations in order
3. Update forms section by section
4. Test end-to-end
5. Deploy Phase 1

**Success Criteria:**
- [ ] All 10 P0 fields implemented
- [ ] Migrations run successfully
- [ ] Forms show all new required fields
- [ ] Data saves correctly
- [ ] No regression on existing features
- [ ] Customer can test and provide feedback

---

**Created:** 2026-01-19
**Ready to Start:** YES
**Next Task:** Task 1.1 - Backend Migration Section 1
