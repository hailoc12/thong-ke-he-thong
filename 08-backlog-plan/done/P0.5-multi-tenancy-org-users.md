# P0.5: Multi-Tenancy & Organization User Management

**Priority**: P0.5 (Between must-have and nice-to-have - CRITICAL for production use)
**Estimate**: 12 hours (2 working days)
**Status**: TODO
**Created**: 2026-01-17
**User Request**: "ƒë·∫∑c bi·ªát l√† feature qu·∫£n l√Ω c·∫•p ph√°t t√†i kho·∫£n c√°c ƒë∆°n v·ªã + cho ph√©p c√°c ƒë∆°n v·ªã login & b·ªï sung th√™m h·ªá th·ªëng c·ªßa ƒë∆°n v·ªã m√¨nh"

---

## üìù Overview

**Business Requirement:**
Hi·ªán t·∫°i h·ªá th·ªëng ch·ªâ c√≥ 1 admin account qu·∫£n l√Ω t·∫•t c·∫£. C·∫ßn implement multi-tenancy ƒë·ªÉ:
1. **Admin** c√≥ th·ªÉ t·∫°o t√†i kho·∫£n cho t·ª´ng ƒë∆°n v·ªã (organization)
2. **User c·ªßa m·ªói ƒë∆°n v·ªã** c√≥ th·ªÉ login v√†o h·ªá th·ªëng
3. **User ch·ªâ th·∫•y v√† qu·∫£n l√Ω h·ªá th·ªëng c·ªßa ƒë∆°n v·ªã m√¨nh** (kh√¥ng th·∫•y ƒë∆°n v·ªã kh√°c)
4. **User c√≥ th·ªÉ th√™m/s·ª≠a h·ªá th·ªëng c·ªßa ƒë∆°n v·ªã m√¨nh**

**Example:**
- Admin t·∫°o account cho "VƒÉn ph√≤ng B·ªô" (user: vanphongbo, password: xxx)
- User "vanphongbo" login v√†o h·ªá th·ªëng
- User ch·ªâ th·∫•y 2 systems c·ªßa VƒÉn ph√≤ng B·ªô (QLVB-001, PORTAL-003)
- User c√≥ th·ªÉ th√™m system m·ªõi cho VƒÉn ph√≤ng B·ªô
- User KH√îNG th·∫•y systems c·ªßa ƒë∆°n v·ªã kh√°c (V·ª• K·∫ø ho·∫°ch, C·ª•c S·ªü h·ªØu tr√≠ tu·ªá, etc.)

---

## üéØ Goals

1. **Role-Based Access Control (RBAC)**
   - Role: `admin` - Full access to everything
   - Role: `org_user` - Access only to their organization's data

2. **Organization-Scoped Data Access**
   - Filter systems by user's organization
   - Restrict create/edit/delete to own organization

3. **User Management by Admin**
   - Admin can create users and assign them to organizations
   - Admin can view all users
   - Admin can deactivate users

4. **Self-Service for Org Users**
   - Org users can manage systems of their organization
   - Org users can view their organization info (read-only)

---

## üîß Technical Implementation

### 1. Backend Changes

#### Update User Model (`backend/users/models.py`)

```python
from django.db import models
from django.contrib.auth.models import AbstractUser

class User(AbstractUser):
    ROLE_CHOICES = [
        ('admin', 'Administrator'),
        ('org_user', 'Organization User'),
    ]

    role = models.CharField(
        max_length=20,
        choices=ROLE_CHOICES,
        default='org_user'
    )
    organization = models.ForeignKey(
        'organizations.Organization',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='users'
    )
    full_name = models.CharField(max_length=255, blank=True)
    phone = models.CharField(max_length=20, blank=True)
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.username} ({self.get_role_display()})"
```

**Migration:**
```bash
python manage.py makemigrations users
python manage.py migrate users
```

#### Create Custom Permissions (`backend/users/permissions.py`)

```python
from rest_framework import permissions

class IsAdmin(permissions.BasePermission):
    """
    Only admin users can access.
    """
    def has_permission(self, request, view):
        return request.user.is_authenticated and request.user.role == 'admin'


class IsOrgUserOrAdmin(permissions.BasePermission):
    """
    Org users can only access their own organization's data.
    Admins can access everything.
    """
    def has_permission(self, request, view):
        return request.user.is_authenticated

    def has_object_permission(self, request, view, obj):
        # Admin can access everything
        if request.user.role == 'admin':
            return True

        # Org user can only access their org's data
        if hasattr(obj, 'organization'):
            return obj.organization == request.user.organization

        return False


class CanManageOrgSystems(permissions.BasePermission):
    """
    Check if user can manage systems for a given organization.
    """
    def has_permission(self, request, view):
        if not request.user.is_authenticated:
            return False

        # Admin can manage any org
        if request.user.role == 'admin':
            return True

        # Org user can only manage their own org's systems
        if request.method in ['POST', 'PUT', 'PATCH']:
            org_id = request.data.get('organization')
            return str(request.user.organization.id) == str(org_id)

        return True
```

#### Update System ViewSet (`backend/systems/views.py`)

```python
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from users.permissions import CanManageOrgSystems
from django.db.models import Q

class SystemViewSet(viewsets.ModelViewSet):
    serializer_class = SystemSerializer
    permission_classes = [IsAuthenticated, CanManageOrgSystems]

    def get_queryset(self):
        """
        Filter systems based on user role:
        - Admin: see all systems
        - Org user: see only their organization's systems
        """
        user = self.request.user

        if user.role == 'admin':
            return System.objects.all()

        # Org user: filter by their organization
        return System.objects.filter(organization=user.organization)

    def perform_create(self, serializer):
        """
        Auto-assign organization for org_user.
        """
        user = self.request.user

        if user.role == 'org_user':
            # Force organization to user's org
            serializer.save(organization=user.organization)
        else:
            # Admin can choose any org
            serializer.save()
```

#### Update Organization ViewSet (`backend/organizations/views.py`)

```python
class OrganizationViewSet(viewsets.ModelViewSet):
    serializer_class = OrganizationSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        """
        Filter organizations based on user role:
        - Admin: see all organizations
        - Org user: see only their own organization
        """
        user = self.request.user

        if user.role == 'admin':
            return Organization.objects.all()

        # Org user: only their organization
        return Organization.objects.filter(id=user.organization.id)
```

#### Create User Management API (`backend/users/views.py`)

```python
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from .permissions import IsAdmin
from .serializers import UserSerializer, UserCreateSerializer

class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all()
    permission_classes = [IsAuthenticated, IsAdmin]  # Only admin can manage users

    def get_serializer_class(self):
        if self.action == 'create':
            return UserCreateSerializer
        return UserSerializer

    @action(detail=False, methods=['get'], permission_classes=[IsAuthenticated])
    def me(self, request):
        """
        Get current user profile.
        Any authenticated user can access this.
        """
        serializer = UserSerializer(request.user)
        return Response(serializer.data)

    @action(detail=True, methods=['patch'])
    def deactivate(self, request, pk=None):
        """
        Deactivate a user.
        """
        user = self.get_object()
        user.is_active = False
        user.save()
        return Response({'status': 'user deactivated'})

    @action(detail=True, methods=['patch'])
    def activate(self, request, pk=None):
        """
        Activate a user.
        """
        user = self.get_object()
        user.is_active = True
        user.save()
        return Response({'status': 'user activated'})
```

#### User Serializers (`backend/users/serializers.py`)

```python
from rest_framework import serializers
from .models import User
from organizations.models import Organization

class UserSerializer(serializers.ModelSerializer):
    organization_name = serializers.CharField(source='organization.name', read_only=True)
    role_display = serializers.CharField(source='get_role_display', read_only=True)

    class Meta:
        model = User
        fields = [
            'id', 'username', 'email', 'full_name', 'phone',
            'role', 'role_display', 'organization', 'organization_name',
            'is_active', 'date_joined', 'last_login'
        ]
        read_only_fields = ['id', 'date_joined', 'last_login']


class UserCreateSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True, required=True)

    class Meta:
        model = User
        fields = [
            'username', 'email', 'password', 'full_name', 'phone',
            'role', 'organization'
        ]

    def validate(self, data):
        # If role is org_user, organization is required
        if data.get('role') == 'org_user' and not data.get('organization'):
            raise serializers.ValidationError({
                'organization': 'Organization is required for org_user role.'
            })

        # If role is admin, organization should be null
        if data.get('role') == 'admin':
            data['organization'] = None

        return data

    def create(self, validated_data):
        password = validated_data.pop('password')
        user = User.objects.create_user(**validated_data)
        user.set_password(password)
        user.save()
        return user
```

#### Update Login Response (`backend/users/views.py`)

```python
class LoginView(APIView):
    def post(self, request):
        username = request.data.get('username')
        password = request.data.get('password')

        user = authenticate(username=username, password=password)

        if user and user.is_active:
            refresh = RefreshToken.for_user(user)

            return Response({
                'access': str(refresh.access_token),
                'refresh': str(refresh),
                'user': {
                    'id': user.id,
                    'username': user.username,
                    'email': user.email,
                    'full_name': user.full_name,
                    'role': user.role,
                    'organization': user.organization.id if user.organization else None,
                    'organization_name': user.organization.name if user.organization else None,
                }
            })

        return Response(
            {'error': 'Invalid credentials or account deactivated'},
            status=status.HTTP_401_UNAUTHORIZED
        )
```

---

### 2. Frontend Changes

#### Update Auth Context/Store (`frontend/src/store/authStore.ts`)

```typescript
import create from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: number;
  username: string;
  email: string;
  full_name: string;
  role: 'admin' | 'org_user';
  organization?: number;
  organization_name?: string;
}

interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isAdmin: boolean;
  login: (user: User, token: string) => void;
  logout: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      token: null,
      isAuthenticated: false,
      isAdmin: false,

      login: (user: User, token: string) => set({
        user,
        token,
        isAuthenticated: true,
        isAdmin: user.role === 'admin',
      }),

      logout: () => set({
        user: null,
        token: null,
        isAuthenticated: false,
        isAdmin: false,
      }),
    }),
    {
      name: 'auth-storage',
    }
  )
);
```

#### Update Login Handler (`frontend/src/pages/Login.tsx`)

```typescript
const handleLogin = async (values: LoginFormValues) => {
  try {
    setLoading(true);
    const response = await api.post('/users/login/', values);

    const { access, user } = response.data;

    // Save to auth store
    useAuthStore.getState().login(user, access);

    // Set API default authorization header
    api.defaults.headers.common['Authorization'] = `Bearer ${access}`;

    message.success('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
    navigate('/');
  } catch (error: any) {
    message.error(error.response?.data?.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
  } finally {
    setLoading(false);
  }
};
```

#### Conditional Sidebar Menu (`frontend/src/components/Layout.tsx`)

```typescript
const Sidebar = () => {
  const { user, isAdmin } = useAuthStore();

  return (
    <Menu mode="inline" defaultSelectedKeys={['dashboard']}>
      <Menu.Item key="dashboard" icon={<DashboardOutlined />}>
        <Link to="/">Dashboard</Link>
      </Menu.Item>

      <Menu.Item key="systems" icon={<AppstoreOutlined />}>
        <Link to="/systems">H·ªá th·ªëng</Link>
      </Menu.Item>

      {/* Only admin can see Organizations menu */}
      {isAdmin && (
        <Menu.Item key="organizations" icon={<TeamOutlined />}>
          <Link to="/organizations">ƒê∆°n v·ªã</Link>
        </Menu.Item>
      )}

      {/* Only admin can manage users */}
      {isAdmin && (
        <Menu.Item key="users" icon={<UserOutlined />}>
          <Link to="/users">Ng∆∞·ªùi d√πng</Link>
        </Menu.Item>
      )}
    </Menu>
  );
};
```

#### Hide Organization Field for Org Users (`frontend/src/pages/SystemCreate.tsx`)

```typescript
const SystemCreateForm = () => {
  const { user, isAdmin } = useAuthStore();

  return (
    <Form>
      {/* Only show organization dropdown for admin */}
      {isAdmin && (
        <Form.Item
          name="organization"
          label="ƒê∆°n v·ªã"
          rules={[{ required: true, message: 'Vui l√≤ng ch·ªçn ƒë∆°n v·ªã' }]}
        >
          <Select placeholder="Ch·ªçn ƒë∆°n v·ªã">
            {organizations.map(org => (
              <Select.Option key={org.id} value={org.id}>
                {org.name}
              </Select.Option>
            ))}
          </Select>
        </Form.Item>
      )}

      {/* For org_user, show organization name (read-only) */}
      {!isAdmin && user?.organization_name && (
        <Form.Item label="ƒê∆°n v·ªã">
          <Input value={user.organization_name} disabled />
        </Form.Item>
      )}

      {/* Rest of form fields */}
    </Form>
  );
};
```

#### User Management Page (`frontend/src/pages/Users.tsx`)

```typescript
import React, { useState, useEffect } from 'react';
import { Table, Button, Modal, Form, Input, Select, message, Space, Tag } from 'antd';
import { PlusOutlined, EditOutlined, StopOutlined, CheckCircleOutlined } from '@ant-design/icons';
import api from '../config/api';

interface User {
  id: number;
  username: string;
  email: string;
  full_name: string;
  phone: string;
  role: 'admin' | 'org_user';
  role_display: string;
  organization?: number;
  organization_name?: string;
  is_active: boolean;
  date_joined: string;
}

const Users: React.FC = () => {
  const [users, setUsers] = useState<User[]>([]);
  const [organizations, setOrganizations] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [modalVisible, setModalVisible] = useState(false);
  const [form] = Form.useForm();

  useEffect(() => {
    fetchUsers();
    fetchOrganizations();
  }, []);

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const response = await api.get('/users/');
      setUsers(response.data.results || response.data);
    } catch (error) {
      message.error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng');
    } finally {
      setLoading(false);
    }
  };

  const fetchOrganizations = async () => {
    try {
      const response = await api.get('/organizations/');
      setOrganizations(response.data.results || response.data);
    } catch (error) {
      console.error('Failed to fetch organizations:', error);
    }
  };

  const handleCreate = async (values: any) => {
    try {
      await api.post('/users/', values);
      message.success('T·∫°o ng∆∞·ªùi d√πng th√†nh c√¥ng!');
      setModalVisible(false);
      form.resetFields();
      fetchUsers();
    } catch (error: any) {
      message.error(error.response?.data?.detail || 'T·∫°o ng∆∞·ªùi d√πng th·∫•t b·∫°i');
    }
  };

  const handleDeactivate = async (userId: number) => {
    try {
      await api.patch(`/users/${userId}/deactivate/`);
      message.success('V√¥ hi·ªáu h√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng');
      fetchUsers();
    } catch (error) {
      message.error('V√¥ hi·ªáu h√≥a th·∫•t b·∫°i');
    }
  };

  const handleActivate = async (userId: number) => {
    try {
      await api.patch(`/users/${userId}/activate/`);
      message.success('K√≠ch ho·∫°t ng∆∞·ªùi d√πng th√†nh c√¥ng');
      fetchUsers();
    } catch (error) {
      message.error('K√≠ch ho·∫°t th·∫•t b·∫°i');
    }
  };

  const columns = [
    {
      title: 'T√™n ƒëƒÉng nh·∫≠p',
      dataIndex: 'username',
      key: 'username',
    },
    {
      title: 'Email',
      dataIndex: 'email',
      key: 'email',
    },
    {
      title: 'H·ªç t√™n',
      dataIndex: 'full_name',
      key: 'full_name',
    },
    {
      title: 'Vai tr√≤',
      dataIndex: 'role_display',
      key: 'role',
      render: (text: string, record: User) => (
        <Tag color={record.role === 'admin' ? 'red' : 'blue'}>
          {text}
        </Tag>
      ),
    },
    {
      title: 'ƒê∆°n v·ªã',
      dataIndex: 'organization_name',
      key: 'organization',
      render: (text: string) => text || '-',
    },
    {
      title: 'Tr·∫°ng th√°i',
      dataIndex: 'is_active',
      key: 'is_active',
      render: (active: boolean) => (
        <Tag color={active ? 'green' : 'red'}>
          {active ? 'Ho·∫°t ƒë·ªông' : 'V√¥ hi·ªáu h√≥a'}
        </Tag>
      ),
    },
    {
      title: 'Thao t√°c',
      key: 'actions',
      render: (_: any, record: User) => (
        <Space>
          {record.is_active ? (
            <Button
              danger
              size="small"
              icon={<StopOutlined />}
              onClick={() => handleDeactivate(record.id)}
            >
              V√¥ hi·ªáu h√≥a
            </Button>
          ) : (
            <Button
              type="primary"
              size="small"
              icon={<CheckCircleOutlined />}
              onClick={() => handleActivate(record.id)}
            >
              K√≠ch ho·∫°t
            </Button>
          )}
        </Space>
      ),
    },
  ];

  return (
    <div>
      <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between' }}>
        <h2>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
        <Button
          type="primary"
          icon={<PlusOutlined />}
          onClick={() => setModalVisible(true)}
        >
          Th√™m ng∆∞·ªùi d√πng
        </Button>
      </div>

      <Table
        columns={columns}
        dataSource={users}
        loading={loading}
        rowKey="id"
        pagination={{ pageSize: 20 }}
      />

      <Modal
        title="Th√™m ng∆∞·ªùi d√πng"
        open={modalVisible}
        onCancel={() => {
          setModalVisible(false);
          form.resetFields();
        }}
        footer={null}
        width={600}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={handleCreate}
        >
          <Form.Item
            name="username"
            label="T√™n ƒëƒÉng nh·∫≠p"
            rules={[{ required: true, message: 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p' }]}
          >
            <Input placeholder="username" />
          </Form.Item>

          <Form.Item
            name="email"
            label="Email"
            rules={[
              { required: true, message: 'Vui l√≤ng nh·∫≠p email' },
              { type: 'email', message: 'Email kh√¥ng h·ª£p l·ªá' }
            ]}
          >
            <Input placeholder="email@example.com" />
          </Form.Item>

          <Form.Item
            name="password"
            label="M·∫≠t kh·∫©u"
            rules={[
              { required: true, message: 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u' },
              { min: 8, message: 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±' }
            ]}
          >
            <Input.Password placeholder="M·∫≠t kh·∫©u" />
          </Form.Item>

          <Form.Item
            name="full_name"
            label="H·ªç t√™n"
          >
            <Input placeholder="Nguy·ªÖn VƒÉn A" />
          </Form.Item>

          <Form.Item
            name="phone"
            label="S·ªë ƒëi·ªán tho·∫°i"
          >
            <Input placeholder="024 1234 5678" />
          </Form.Item>

          <Form.Item
            name="role"
            label="Vai tr√≤"
            rules={[{ required: true, message: 'Vui l√≤ng ch·ªçn vai tr√≤' }]}
          >
            <Select placeholder="Ch·ªçn vai tr√≤">
              <Select.Option value="admin">Administrator</Select.Option>
              <Select.Option value="org_user">Organization User</Select.Option>
            </Select>
          </Form.Item>

          <Form.Item
            noStyle
            shouldUpdate={(prevValues, currentValues) => prevValues.role !== currentValues.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'org_user' ? (
                <Form.Item
                  name="organization"
                  label="ƒê∆°n v·ªã"
                  rules={[{ required: true, message: 'Vui l√≤ng ch·ªçn ƒë∆°n v·ªã' }]}
                >
                  <Select placeholder="Ch·ªçn ƒë∆°n v·ªã">
                    {organizations.map(org => (
                      <Select.Option key={org.id} value={org.id}>
                        {org.name}
                      </Select.Option>
                    ))}
                  </Select>
                </Form.Item>
              ) : null
            }
          </Form.Item>

          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                T·∫°o ng∆∞·ªùi d√πng
              </Button>
              <Button onClick={() => {
                setModalVisible(false);
                form.resetFields();
              }}>
                H·ªßy
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default Users;
```

#### Add Users Route (`frontend/src/App.tsx`)

```typescript
import Users from './pages/Users';

// Inside Routes:
<Route path="users" element={<Users />} />
```

---

## ‚úÖ Acceptance Criteria

### Admin Features
- [ ] Admin can create new user accounts
- [ ] Admin can assign users to organizations
- [ ] Admin can set user roles (admin or org_user)
- [ ] Admin can deactivate/activate users
- [ ] Admin can view all users in a table
- [ ] Admin can see all organizations
- [ ] Admin can see all systems from all organizations
- [ ] Admin can create systems for any organization

### Org User Features
- [ ] Org user can login with their credentials
- [ ] Org user sees only their organization's systems in the list
- [ ] Org user can create new systems (auto-assigned to their org)
- [ ] Org user can edit systems of their organization
- [ ] Org user can view details of their organization's systems
- [ ] Org user CANNOT see other organizations' data
- [ ] Org user CANNOT see Organizations menu
- [ ] Org user CANNOT see Users management menu
- [ ] Org user CANNOT change their organization assignment

### Security
- [ ] API endpoints enforce permission checks
- [ ] Database queries are filtered by organization
- [ ] Users cannot access data outside their organization via API
- [ ] Password is hashed (never stored in plain text)
- [ ] Login returns user role and organization info

---

## üß™ Testing Checklist

### Setup Test Data
```bash
# Create admin user
python manage.py createsuperuser
# username: admin, password: Admin@2026

# Create test org users via Django shell or Admin panel
User.objects.create_user(
    username='vanphongbo',
    password='test123',
    email='vpb@most.gov.vn',
    role='org_user',
    organization_id=1,  # VƒÉn ph√≤ng B·ªô
    full_name='Nguy·ªÖn VƒÉn A'
)

User.objects.create_user(
    username='vkehoach',
    password='test123',
    email='kh@most.gov.vn',
    role='org_user',
    organization_id=11,  # V·ª• K·∫ø ho·∫°ch - T√†i ch√≠nh
    full_name='L√™ VƒÉn C'
)
```

### Test Cases

**TC1: Admin Login**
- [ ] Login as admin
- [ ] Can see "ƒê∆°n v·ªã" menu
- [ ] Can see "Ng∆∞·ªùi d√πng" menu
- [ ] Can see all systems (5 systems)
- [ ] Can create system for any organization

**TC2: Org User Login (VƒÉn ph√≤ng B·ªô)**
- [ ] Login as vanphongbo
- [ ] Dashboard shows only their org's systems count
- [ ] Systems page shows only 2 systems (QLVB-001, PORTAL-003)
- [ ] CANNOT see "ƒê∆°n v·ªã" menu
- [ ] CANNOT see "Ng∆∞·ªùi d√πng" menu
- [ ] Click "Th√™m h·ªá th·ªëng" ‚Üí Organization field is hidden (auto-set)
- [ ] Create new system ‚Üí Success ‚Üí System belongs to VƒÉn ph√≤ng B·ªô

**TC3: Org User Login (V·ª• K·∫ø ho·∫°ch)**
- [ ] Login as vkehoach
- [ ] Systems page shows only 1 system (BCTK-005)
- [ ] CANNOT see systems from other orgs

**TC4: Data Isolation**
- [ ] Login as vanphongbo
- [ ] Try to access system ID 2 (belongs to V·ª• KHKT&CN) via URL `/systems/2`
- [ ] Should get 404 or Permission Denied
- [ ] Try to edit system ID 2 via API ‚Üí Should fail

**TC5: User Management (Admin)**
- [ ] Login as admin
- [ ] Navigate to Users page
- [ ] Click "Th√™m ng∆∞·ªùi d√πng"
- [ ] Create user with role=org_user, org=C·ª•c S·ªü h·ªØu tr√≠ tu·ªá
- [ ] User created successfully
- [ ] Logout and login with new user
- [ ] New user only sees systems from C·ª•c S·ªü h·ªØu tr√≠ tu·ªá

---

## üì¶ Database Migration Plan

### Step 1: Add role and organization fields to User model
```bash
python manage.py makemigrations users
```

### Step 2: Run migration
```bash
python manage.py migrate users
```

### Step 3: Update existing admin user
```bash
python manage.py shell
>>> from users.models import User
>>> admin = User.objects.get(username='admin')
>>> admin.role = 'admin'
>>> admin.save()
```

### Step 4: Create sample org users
```python
# Via Django shell or admin panel
from users.models import User
from organizations.models import Organization

vpb = Organization.objects.get(code='VPBO')
User.objects.create_user(
    username='vanphongbo',
    password='Vanphongbo@2026',
    email='vanphong@most.gov.vn',
    role='org_user',
    organization=vpb,
    full_name='Nguy·ªÖn VƒÉn A - VƒÉn ph√≤ng B·ªô'
)

vkhtc = Organization.objects.get(code='VKHTC')
User.objects.create_user(
    username='vkehoach',
    password='Vkehoach@2026',
    email='kehoach@most.gov.vn',
    role='org_user',
    organization=vkhtc,
    full_name='L√™ VƒÉn C - V·ª• K·∫ø ho·∫°ch'
)

# Create more users for other orgs...
```

---

## üöÄ Deployment Checklist

### Backend Deployment
- [ ] Commit all backend changes
- [ ] Push to GitHub
- [ ] Pull on production server
- [ ] Run migrations: `docker-compose exec backend python manage.py migrate`
- [ ] Update existing admin user role
- [ ] Restart backend container
- [ ] Test API endpoints with Postman

### Frontend Deployment
- [ ] Commit all frontend changes
- [ ] Push to GitHub
- [ ] Pull on production server
- [ ] Rebuild frontend: `docker-compose build frontend`
- [ ] Restart frontend container
- [ ] Clear browser cache
- [ ] Test login flows

### Create Sample Org Users
- [ ] Use Django admin or shell to create 2-3 sample org users
- [ ] Test login with each user
- [ ] Verify data isolation

---

## üìù Documentation

### Admin Manual - User Management

**T·∫°o t√†i kho·∫£n cho ƒë∆°n v·ªã:**

1. Login v·ªõi t√†i kho·∫£n admin
2. V√†o menu "Ng∆∞·ªùi d√πng"
3. Click "Th√™m ng∆∞·ªùi d√πng"
4. ƒêi·ªÅn th√¥ng tin:
   - T√™n ƒëƒÉng nh·∫≠p: (vd: vanphongbo)
   - Email: (vd: vanphong@most.gov.vn)
   - M·∫≠t kh·∫©u: T·ªëi thi·ªÉu 8 k√Ω t·ª±
   - H·ªç t√™n: (vd: Nguy·ªÖn VƒÉn A)
   - Vai tr√≤: Ch·ªçn "Organization User"
   - ƒê∆°n v·ªã: Ch·ªçn ƒë∆°n v·ªã ph√π h·ª£p
5. Click "T·∫°o ng∆∞·ªùi d√πng"
6. Th√¥ng b√°o t√†i kho·∫£n cho ng∆∞·ªùi d√πng

**V√¥ hi·ªáu h√≥a t√†i kho·∫£n:**
- V√†o danh s√°ch ng∆∞·ªùi d√πng
- Click "V√¥ hi·ªáu h√≥a" ·ªü d√≤ng ng∆∞·ªùi d√πng c·∫ßn kh√≥a

### Org User Manual

**ƒêƒÉng nh·∫≠p:**
1. Truy c·∫≠p https://thongkehethong.mindmaid.ai
2. Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u
3. Click "ƒêƒÉng nh·∫≠p"

**Xem danh s√°ch h·ªá th·ªëng:**
- Click menu "H·ªá th·ªëng"
- B·∫°n ch·ªâ th·∫•y c√°c h·ªá th·ªëng c·ªßa ƒë∆°n v·ªã m√¨nh

**Th√™m h·ªá th·ªëng m·ªõi:**
- Click "Th√™m h·ªá th·ªëng"
- ƒêi·ªÅn form wizard (6 b∆∞·ªõc)
- Click "T·∫°o h·ªá th·ªëng"
- H·ªá th·ªëng t·ª± ƒë·ªông thu·ªôc v·ªÅ ƒë∆°n v·ªã c·ªßa b·∫°n

---

## üéØ Success Metrics

- [ ] Admin can create >= 5 org user accounts
- [ ] Each org user can login successfully
- [ ] Org users only see their organization's data (0 unauthorized access)
- [ ] System performance not degraded (response time < 500ms)
- [ ] No security vulnerabilities (pass security audit)

---

## üîí Security Considerations

1. **Password Security:**
   - Minimum 8 characters
   - Use Django's built-in password hashing
   - Consider adding password strength requirements

2. **Permission Enforcement:**
   - Always check permissions on backend (never trust frontend)
   - Filter queryset by organization
   - Validate organization ownership on create/update

3. **Session Management:**
   - Use JWT tokens with expiration
   - Implement refresh token mechanism
   - Consider adding "remember me" feature (P1-remember-me-feature.md)

4. **Audit Trail (Future):**
   - Log all user actions (create, update, delete)
   - Track login/logout events
   - Monitor failed login attempts

---

## üìã Follow-up Tasks (After P0.5)

After implementing multi-tenancy, consider:

1. **P1-remember-me-feature.md** - Auto-login for convenience
2. **User Profile Page** - Allow users to change password, update info
3. **Password Reset** - Email-based password reset flow
4. **Two-Factor Authentication** - Additional security layer
5. **Audit Logs** - Track all changes for compliance

---

**Created**: 2026-01-17
**Priority**: P0.5 (Critical for production deployment)
**Estimated effort**: 12 hours (2 days)
**Dependencies**: P0-1, P0-2, P0-3, P0-4 (all complete ‚úÖ)
