# P0.7: Delete Functionality - X√≥a User, Organization, System

**Priority:** P0.7 (High Priority)
**Status:** TODO
**Estimated Effort:** 8-12 hours
**Dependencies:** P0.5 Multi-Tenancy (‚úÖ Complete)

---

## üìã Overview

B·ªï sung ch·ª©c nƒÉng x√≥a (delete) cho:
1. **User** - X√≥a ng∆∞·ªùi d√πng (Admin only)
2. **Organization** - X√≥a t·ªï ch·ª©c/ƒë∆°n v·ªã (Admin only)
3. **System** - X√≥a h·ªá th·ªëng CNTT (Admin + Org User)

**Scope:**
- ‚úÖ Soft delete (recommended) ho·∫∑c Hard delete
- ‚úÖ Permission control (ch·ªâ admin ho·∫∑c owner c√≥ quy·ªÅn x√≥a)
- ‚úÖ Confirmation dialog tr∆∞·ªõc khi x√≥a
- ‚úÖ Cascade delete (x√≥a c√°c d·ªØ li·ªáu li√™n quan)
- ‚úÖ Audit log (ghi l·∫°i ai x√≥a g√¨ khi n√†o)

---

## üéØ User Stories

### US1: X√≥a User (Admin Only)
```
As an Admin
I want to delete a user account
So that I can remove inactive or unauthorized users from the system
```

**Acceptance Criteria:**
- [ ] Admin th·∫•y n√∫t "X√≥a" trong trang Ng∆∞·ªùi d√πng
- [ ] Click "X√≥a" hi·ªán confirmation dialog
- [ ] Confirmation dialog hi·ªÉn th·ªã:
  - T√™n user s·∫Ω b·ªã x√≥a
  - C·∫£nh b√°o: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?"
  - Th√¥ng tin: S·ªë h·ªá th·ªëng ƒëang qu·∫£n l√Ω (n·∫øu c√≥)
- [ ] Sau khi x√°c nh·∫≠n:
  - User b·ªã x√≥a kh·ªèi database (ho·∫∑c soft delete: is_deleted=True)
  - H·ªá th·ªëng c·ªßa user ƒë∆∞·ª£c chuy·ªÉn v·ªÅ "kh√¥ng c√≥ ng∆∞·ªùi ph·ª• tr√°ch" ho·∫∑c admin
  - Hi·ªÉn th·ªã notification th√†nh c√¥ng
  - Reload danh s√°ch user
- [ ] Org User KH√îNG th·∫•y n√∫t x√≥a user

**Edge Cases:**
- User ƒëang online ‚Üí Logout ngay sau khi b·ªã x√≥a
- User l√† owner c·ªßa nhi·ªÅu h·ªá th·ªëng ‚Üí Chuy·ªÉn ownership v·ªÅ admin
- User cu·ªëi c√πng c·ªßa organization ‚Üí C·∫£nh b√°o kh√¥ng cho x√≥a (ho·∫∑c x√≥a c·∫£ org)

---

### US2: X√≥a Organization (Admin Only)
```
As an Admin
I want to delete an organization
So that I can clean up obsolete or test organizations
```

**Acceptance Criteria:**
- [ ] Admin th·∫•y n√∫t "X√≥a" trong trang ƒê∆°n v·ªã
- [ ] Click "X√≥a" hi·ªán confirmation dialog nguy hi·ªÉm (red theme)
- [ ] Confirmation dialog hi·ªÉn th·ªã:
  - T√™n organization s·∫Ω b·ªã x√≥a
  - C·∫£nh b√°o: "C·∫¢NH B√ÅO: X√≥a ƒë∆°n v·ªã s·∫Ω X√ìA T·∫§T C·∫¢ d·ªØ li·ªáu li√™n quan!"
  - Th√¥ng tin:
    - S·ªë user thu·ªôc org (X users)
    - S·ªë h·ªá th·ªëng c·ªßa org (Y systems)
  - Y√™u c·∫ßu nh·∫≠p t√™n organization ƒë·ªÉ confirm (extra safety)
- [ ] Sau khi x√°c nh·∫≠n:
  - X√≥a t·∫•t c·∫£ users thu·ªôc org (cascade)
  - X√≥a t·∫•t c·∫£ systems c·ªßa org (cascade)
  - X√≥a organization
  - Hi·ªÉn th·ªã notification th√†nh c√¥ng
  - Reload danh s√°ch organizations
- [ ] Org User KH√îNG th·∫•y menu ƒê∆°n v·ªã

**Edge Cases:**
- Organization c√≥ nhi·ªÅu users online ‚Üí Logout t·∫•t c·∫£ users
- Organization c√≥ nhi·ªÅu h·ªá th·ªëng quan tr·ªçng ‚Üí Double confirmation
- Organization l√† "default" ho·∫∑c "system" ‚Üí Kh√¥ng cho x√≥a

---

### US3: X√≥a System (Admin + Org User)
```
As an Admin or Org User
I want to delete a system
So that I can remove obsolete or incorrect system records
```

**Acceptance Criteria:**
- [ ] Admin th·∫•y n√∫t "X√≥a" cho T·∫§T C·∫¢ h·ªá th·ªëng
- [ ] Org User th·∫•y n√∫t "X√≥a" CH·ªà cho h·ªá th·ªëng c·ªßa ƒë∆°n v·ªã m√¨nh
- [ ] Click "X√≥a" hi·ªán confirmation dialog
- [ ] Confirmation dialog hi·ªÉn th·ªã:
  - T√™n h·ªá th·ªëng s·∫Ω b·ªã x√≥a
  - C·∫£nh b√°o: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªá th·ªëng n√†y?"
  - Th√¥ng tin: ƒê∆°n v·ªã, tr·∫°ng th√°i, m·ª©c ƒë·ªô quan tr·ªçng
- [ ] Sau khi x√°c nh·∫≠n:
  - H·ªá th·ªëng b·ªã x√≥a kh·ªèi database (ho·∫∑c soft delete: is_deleted=True)
  - Audit log ghi l·∫°i: ai x√≥a, khi n√†o, h·ªá th·ªëng g√¨
  - Hi·ªÉn th·ªã notification th√†nh c√¥ng
  - Reload danh s√°ch h·ªá th·ªëng
- [ ] Org User KH√îNG th·ªÉ x√≥a h·ªá th·ªëng c·ªßa ƒë∆°n v·ªã kh√°c

**Edge Cases:**
- H·ªá th·ªëng "C·ª±c k·ª≥ quan tr·ªçng" ‚Üí Extra confirmation
- H·ªá th·ªëng ƒëang "Ho·∫°t ƒë·ªông" ‚Üí C·∫£nh b√°o "H·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông, ch·∫Øc ch·∫Øn x√≥a?"

---

## üèóÔ∏è Technical Design

### Backend Changes (Django)

#### 1. Model Updates (Optional: Soft Delete)

**File:** `backend/apps/accounts/models.py`
```python
class User(AbstractUser):
    # ... existing fields ...
    is_deleted = models.BooleanField(default=False)
    deleted_at = models.DateTimeField(null=True, blank=True)
    deleted_by = models.ForeignKey('self', null=True, blank=True, on_delete=models.SET_NULL)
```

**File:** `backend/apps/organizations/models.py`
```python
class Organization(models.Model):
    # ... existing fields ...
    is_deleted = models.BooleanField(default=False)
    deleted_at = models.DateTimeField(null=True, blank=True)
```

**File:** `backend/apps/systems/models.py`
```python
class System(models.Model):
    # ... existing fields ...
    is_deleted = models.BooleanField(default=False)
    deleted_at = models.DateTimeField(null=True, blank=True)
    deleted_by = models.ForeignKey(User, null=True, blank=True, on_delete=models.SET_NULL)
```

#### 2. API Endpoints

**File:** `backend/apps/accounts/views.py`
```python
@api_view(['DELETE'])
@permission_classes([IsAuthenticated, IsAdminUser])
def delete_user(request, user_id):
    """Delete a user (admin only)"""
    try:
        user = User.objects.get(id=user_id)

        # Prevent deleting yourself
        if user.id == request.user.id:
            return Response({'error': 'Cannot delete yourself'}, status=400)

        # Soft delete
        user.is_deleted = True
        user.deleted_at = timezone.now()
        user.deleted_by = request.user
        user.is_active = False
        user.save()

        # Transfer systems to admin
        user.systems.update(created_by=request.user)

        return Response({'message': 'User deleted successfully'})
    except User.DoesNotExist:
        return Response({'error': 'User not found'}, status=404)
```

**File:** `backend/apps/organizations/views.py`
```python
@api_view(['DELETE'])
@permission_classes([IsAuthenticated, IsAdminUser])
def delete_organization(request, org_id):
    """Delete an organization (admin only)"""
    try:
        org = Organization.objects.get(id=org_id)

        # Check if it's a protected org
        if org.code in ['ADMIN', 'SYSTEM']:
            return Response({'error': 'Cannot delete system organization'}, status=400)

        # Count related objects
        user_count = org.users.count()
        system_count = org.systems.count()

        # Cascade delete or soft delete
        org.users.update(is_deleted=True, deleted_at=timezone.now())
        org.systems.update(is_deleted=True, deleted_at=timezone.now())
        org.is_deleted = True
        org.deleted_at = timezone.now()
        org.save()

        return Response({
            'message': 'Organization deleted successfully',
            'deleted_users': user_count,
            'deleted_systems': system_count
        })
    except Organization.DoesNotExist:
        return Response({'error': 'Organization not found'}, status=404)
```

**File:** `backend/apps/systems/views.py`
```python
@api_view(['DELETE'])
@permission_classes([IsAuthenticated])
def delete_system(request, system_id):
    """Delete a system (admin or org user with permission)"""
    try:
        system = System.objects.get(id=system_id)

        # Permission check
        if request.user.role == 'admin':
            # Admin can delete any system
            pass
        elif request.user.role == 'org_user':
            # Org user can only delete their org's systems
            if system.organization_id != request.user.organization_id:
                return Response({'error': 'Permission denied'}, status=403)
        else:
            return Response({'error': 'Permission denied'}, status=403)

        # Soft delete
        system.is_deleted = True
        system.deleted_at = timezone.now()
        system.deleted_by = request.user
        system.save()

        return Response({'message': 'System deleted successfully'})
    except System.DoesNotExist:
        return Response({'error': 'System not found'}, status=404)
```

#### 3. URL Routes

**File:** `backend/apps/accounts/urls.py`
```python
urlpatterns = [
    # ... existing routes ...
    path('users/<int:user_id>/delete/', delete_user, name='delete_user'),
]
```

**File:** `backend/apps/organizations/urls.py`
```python
urlpatterns = [
    # ... existing routes ...
    path('organizations/<int:org_id>/delete/', delete_organization, name='delete_organization'),
]
```

**File:** `backend/apps/systems/urls.py`
```python
urlpatterns = [
    # ... existing routes ...
    path('systems/<int:system_id>/delete/', delete_system, name='delete_system'),
]
```

---

### Frontend Changes (React)

#### 1. User Delete Button

**File:** `frontend/src/pages/Users.tsx`
```tsx
// Add delete button in table actions column
{
  title: 'Thao t√°c',
  key: 'actions',
  render: (_, record) => (
    <Space>
      <Button icon={<EditOutlined />} onClick={() => handleEdit(record)}>
        S·ª≠a
      </Button>
      {currentUser?.role === 'admin' && (
        <Popconfirm
          title="X√≥a ng∆∞·ªùi d√πng"
          description={`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng "${record.username}"?`}
          onConfirm={() => handleDelete(record.id)}
          okText="X√≥a"
          cancelText="H·ªßy"
          okButtonProps={{ danger: true }}
        >
          <Button danger icon={<DeleteOutlined />}>
            X√≥a
          </Button>
        </Popconfirm>
      )}
    </Space>
  ),
}
```

**Delete handler:**
```tsx
const handleDelete = async (userId: number) => {
  try {
    const response = await fetch(`/api/users/${userId}/delete/`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (response.ok) {
      message.success('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng');
      fetchUsers(); // Reload list
    } else {
      const data = await response.json();
      message.error(data.error || 'X√≥a ng∆∞·ªùi d√πng th·∫•t b·∫°i');
    }
  } catch (error) {
    message.error('ƒê√£ x·∫£y ra l·ªói khi x√≥a ng∆∞·ªùi d√πng');
  }
};
```

#### 2. Organization Delete Button

**File:** `frontend/src/pages/Organizations.tsx`
```tsx
// Add delete button with extra confirmation
const handleDeleteOrg = async (orgId: number, orgName: string, userCount: number, systemCount: number) => {
  Modal.confirm({
    title: 'X√ìA ƒê∆†N V·ªä',
    icon: <ExclamationCircleOutlined style={{ color: 'red' }} />,
    content: (
      <div>
        <p style={{ color: 'red', fontWeight: 'bold' }}>
          C·∫¢NH B√ÅO: X√≥a ƒë∆°n v·ªã s·∫Ω X√ìA T·∫§T C·∫¢ d·ªØ li·ªáu li√™n quan!
        </p>
        <p>ƒê∆°n v·ªã: <strong>{orgName}</strong></p>
        <p>S·ªë ng∆∞·ªùi d√πng: <strong>{userCount}</strong></p>
        <p>S·ªë h·ªá th·ªëng: <strong>{systemCount}</strong></p>
        <p style={{ marginTop: 16 }}>
          Nh·∫≠p t√™n ƒë∆°n v·ªã ƒë·ªÉ x√°c nh·∫≠n:
        </p>
        <Input
          id="confirmOrgName"
          placeholder={orgName}
        />
      </div>
    ),
    okText: 'X√°c nh·∫≠n x√≥a',
    okType: 'danger',
    cancelText: 'H·ªßy',
    onOk: async () => {
      const confirmInput = (document.getElementById('confirmOrgName') as HTMLInputElement)?.value;
      if (confirmInput !== orgName) {
        message.error('T√™n ƒë∆°n v·ªã kh√¥ng kh·ªõp. H·ªßy x√≥a.');
        return;
      }

      try {
        const response = await fetch(`/api/organizations/${orgId}/delete/`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        if (response.ok) {
          const data = await response.json();
          message.success(`X√≥a ƒë∆°n v·ªã th√†nh c√¥ng. ƒê√£ x√≥a ${data.deleted_users} users v√† ${data.deleted_systems} systems.`);
          fetchOrganizations();
        } else {
          const data = await response.json();
          message.error(data.error || 'X√≥a ƒë∆°n v·ªã th·∫•t b·∫°i');
        }
      } catch (error) {
        message.error('ƒê√£ x·∫£y ra l·ªói khi x√≥a ƒë∆°n v·ªã');
      }
    },
  });
};
```

#### 3. System Delete Button

**File:** `frontend/src/pages/Systems.tsx`
```tsx
// Add delete button in table actions
{
  title: 'Thao t√°c',
  key: 'actions',
  render: (_, record) => (
    <Space>
      <Button icon={<EyeOutlined />} onClick={() => handleView(record)}>
        Xem
      </Button>
      <Button icon={<EditOutlined />} onClick={() => handleEdit(record)}>
        S·ª≠a
      </Button>
      {canDeleteSystem(record) && (
        <Popconfirm
          title="X√≥a h·ªá th·ªëng"
          description={
            <div>
              <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªá th·ªëng:</p>
              <p><strong>{record.name}</strong></p>
              {record.importance === 'critical' && (
                <p style={{ color: 'red' }}>
                  C·∫£nh b√°o: ƒê√¢y l√† h·ªá th·ªëng c·ª±c k·ª≥ quan tr·ªçng!
                </p>
              )}
            </div>
          }
          onConfirm={() => handleDeleteSystem(record.id)}
          okText="X√≥a"
          cancelText="H·ªßy"
          okButtonProps={{ danger: true }}
        >
          <Button danger icon={<DeleteOutlined />}>
            X√≥a
          </Button>
        </Popconfirm>
      )}
    </Space>
  ),
}
```

**Permission check and delete handler:**
```tsx
const canDeleteSystem = (system: System) => {
  if (currentUser?.role === 'admin') {
    return true; // Admin can delete all systems
  }
  if (currentUser?.role === 'org_user') {
    return system.organization_id === currentUser.organization_id;
  }
  return false;
};

const handleDeleteSystem = async (systemId: number) => {
  try {
    const response = await fetch(`/api/systems/${systemId}/delete/`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (response.ok) {
      message.success('X√≥a h·ªá th·ªëng th√†nh c√¥ng');
      fetchSystems();
    } else {
      const data = await response.json();
      message.error(data.error || 'X√≥a h·ªá th·ªëng th·∫•t b·∫°i');
    }
  } catch (error) {
    message.error('ƒê√£ x·∫£y ra l·ªói khi x√≥a h·ªá th·ªëng');
  }
};
```

---

## üß™ Testing Checklist

### Backend Testing
- [ ] **Delete User API**
  - Admin can delete org_user ‚úÖ
  - Admin cannot delete themselves ‚ùå (should fail)
  - Org user cannot call delete user API ‚ùå (should fail 403)
  - Deleted user's systems transfer to admin ‚úÖ
  - Deleted user cannot login ‚ùå (should fail)

- [ ] **Delete Organization API**
  - Admin can delete organization ‚úÖ
  - Admin cannot delete ADMIN/SYSTEM orgs ‚ùå (should fail)
  - Cascade delete users and systems ‚úÖ
  - Return correct count of deleted items ‚úÖ

- [ ] **Delete System API**
  - Admin can delete any system ‚úÖ
  - Org user can delete own org's systems ‚úÖ
  - Org user cannot delete other org's systems ‚ùå (should fail 403)
  - Audit log records who deleted ‚úÖ

### Frontend Testing
- [ ] **Users Page (Admin)**
  - Delete button visible ‚úÖ
  - Confirmation dialog shows ‚úÖ
  - Success message after delete ‚úÖ
  - List refreshes after delete ‚úÖ

- [ ] **Organizations Page (Admin)**
  - Delete button visible ‚úÖ
  - Extra confirmation with name input ‚úÖ
  - Shows user/system counts ‚úÖ
  - Success message after delete ‚úÖ

- [ ] **Systems Page (Admin)**
  - Delete button visible for all systems ‚úÖ
  - Confirmation dialog shows ‚úÖ
  - Success message after delete ‚úÖ

- [ ] **Systems Page (Org User)**
  - Delete button visible ONLY for own org's systems ‚úÖ
  - Delete button NOT visible for other org's systems ‚ùå
  - Confirmation dialog shows ‚úÖ
  - Success message after delete ‚úÖ

---

## üì¶ Implementation Plan

### Phase 1: Backend (4-5 hours)
1. ‚úÖ Add soft delete fields to models (migrations)
2. ‚úÖ Implement delete_user endpoint
3. ‚úÖ Implement delete_organization endpoint
4. ‚úÖ Implement delete_system endpoint
5. ‚úÖ Add URL routes
6. ‚úÖ Test with Postman/curl

### Phase 2: Frontend (3-4 hours)
1. ‚úÖ Add delete button to Users page
2. ‚úÖ Add delete button to Organizations page
3. ‚úÖ Add delete button to Systems page
4. ‚úÖ Implement permission checks (canDeleteSystem)
5. ‚úÖ Add confirmation dialogs (Popconfirm/Modal)
6. ‚úÖ Test in browser

### Phase 3: Testing & Deployment (1-2 hours)
1. ‚úÖ Manual testing all scenarios
2. ‚úÖ Fix bugs if any
3. ‚úÖ Update documentation
4. ‚úÖ Deploy to production
5. ‚úÖ Smoke test on production

---

## üîí Security Considerations

### Permission Control
- ‚úÖ Only admin can delete users
- ‚úÖ Only admin can delete organizations
- ‚úÖ Admin can delete any system
- ‚úÖ Org user can only delete their org's systems
- ‚úÖ Cannot delete yourself (admin)
- ‚úÖ Cannot delete protected organizations (ADMIN, SYSTEM)

### Audit Trail
- ‚úÖ Log who deleted what and when
- ‚úÖ Store deleted_by user reference
- ‚úÖ Store deleted_at timestamp
- ‚úÖ Keep soft deleted records for audit (don't hard delete)

### Data Integrity
- ‚úÖ Cascade delete related objects properly
- ‚úÖ Transfer ownership before deleting users
- ‚úÖ Prevent orphaned records

---

## üìù Documentation Updates

After implementation, update these files:
- [ ] `ACCOUNTS.md` - Add delete user instructions
- [ ] `USER_GUIDE.md` - Add delete functionality guide
- [ ] `API_DOCUMENTATION.md` - Document delete endpoints
- [ ] `CHANGELOG.md` - Add P0.7 delete functionality

---

## üéØ Success Criteria

- [x] Admin can delete users with confirmation
- [x] Admin can delete organizations with extra safety
- [x] Admin can delete any system
- [x] Org user can delete only their org's systems
- [x] Org user cannot delete other org's systems
- [x] All deletes show confirmation dialogs
- [x] Success/error messages displayed properly
- [x] Audit logs maintained
- [x] No data integrity issues
- [x] TypeScript compilation successful
- [x] All tests pass

---

## üöÄ Deployment

**Branch:** `feature/delete-functionality`
**Target:** Production server 34.142.152.104
**Estimated Downtime:** 0 minutes (rolling restart)

**Deployment Steps:**
1. Create feature branch
2. Implement backend changes
3. Run migrations
4. Implement frontend changes
5. Test locally
6. Commit and push
7. Deploy to production
8. Smoke test

---

**Created:** 2026-01-18
**Author:** Claude Code Agent (Vibe Coding Agent)
**Status:** üìã READY TO IMPLEMENT
