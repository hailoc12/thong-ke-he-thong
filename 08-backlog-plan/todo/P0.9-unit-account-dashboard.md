# P0.9 Unit Account Management & Progress Dashboard

**Date:** 2026-01-20
**Priority:** P0 - Critical
**Estimated Effort:** 5 days (38 hours)
**Status:** Planning - Not Started

---

## Executive Summary

Implement multi-tenant unit account management system with progress tracking dashboard. Each unit can:
- Have dedicated login accounts
- Report multiple systems
- View dashboard showing:
  - Total systems count
  - Overall completion percentage across all fields
  - Per-system completion status
- Tab-by-tab validation prevents incomplete form submissions

---

## Customer Requirements (Vietnamese)

> C·∫•p t√†i kho·∫£n t·ªõi c√°c ƒë∆°n v·ªã (U+P). ƒê∆°n v·ªã login v√†o v√† b√°o c√°o bao nhi√™u h·ªá th·ªëng. Dashboard ƒë∆°n v·ªã s·∫Ω th·∫•y c√≥ bao nhi√™u h·ªá th·ªëng, t·ªïng ƒë√£ b√°o c√°o ƒëc bao nhi√™u % c√°c tr∆∞·ªùng. Danh s√°ch t·ª´ng h·ªá th·ªëng v√† % ƒë√£ b√°o c√°o ƒë·ªß th√¥ng tin. Nh·∫≠p xong Tab n√†y m·ªõi sang Tab kia ƒë·ªÉ tr√°nh b·ªè s√≥t.

**Translation:**
1. Create accounts for units (Username + Password)
2. Units login and report multiple systems
3. Unit dashboard shows total systems, overall completion %, and per-system progress
4. Force tab completion before moving to next tab

---

## Feature Breakdown

### F1: Unit Account Management ‚úÖ (Already exists)
- Django User model with Organization FK ‚úÖ
- Role-based access control ‚úÖ
- Admin can create unit accounts ‚úÖ
- Need to verify: Data isolation per organization

### F2: Unit Progress Dashboard üÜï (NEW)
- **Backend:** API endpoint to calculate and return progress data
- **Frontend:** Dashboard page with statistics and table

### F3: Tab-by-Tab Validation üÜï (NEW)
- **Frontend:** Validation logic preventing tab switching if incomplete
- **UI:** Visual indicators (‚úÖ/‚ö†Ô∏è) on tabs

---

## Implementation Tasks

### Phase 1: Backend Progress Calculation (Day 1)

**Task 1.1: Create utility function**
- File: `/backend/apps/systems/utils.py`
- Function: `calculate_system_completion_percentage(system_instance)`
- Logic:
  - Define required fields per tab
  - Check if each field is filled (not null, not empty string, not empty array)
  - Return percentage (0-100%)

**Task 1.2: Define required fields map**
```python
REQUIRED_FIELDS_MAP = {
    'tab1': ['system_name', 'system_name_en', 'status', 'scope', 'system_group'],
    'tab2': ['business_objectives', 'user_types', 'annual_users'],
    'tab3': ['programming_language', 'framework', 'database_name', 'hosting_platform'],
    'tab4': ['data_classification_type', 'data_volume'],
    'tab5': ['integrated_internal_systems', 'data_exchange_method'],
    'tab6': ['authentication_method', 'has_encryption'],
    'tab7': ['has_support_team', 'support_level'],
    'tab8': [],  # Optional tab
}
```

**Task 1.3: Write unit tests**
- Test with empty system (0%)
- Test with partially filled system (50%)
- Test with fully filled system (100%)
- Test edge cases (null vs empty string vs empty array)

**Deliverable:** Working utility function with tests

---

### Phase 2: Backend API Endpoint (Day 1-2)

**Task 2.1: Create API view**
- File: `/backend/apps/systems/views.py`
- Class: `UnitProgressDashboardView(APIView)`
- Method: `GET`
- Auth: `IsAuthenticated` permission
- Logic:
  - Get current user's organization
  - Filter systems by organization
  - Calculate completion % for each system
  - Calculate overall completion average
  - Return JSON response

**Task 2.2: Add URL route**
- File: `/backend/apps/systems/urls.py`
- Path: `dashboard/unit-progress/`
- Name: `unit-progress`

**Task 2.3: API tests**
- Test with no systems (empty org)
- Test with multiple systems
- Test org data isolation
- Test permission (unauthenticated user blocked)

**Deliverable:** Working API endpoint with tests

---

### Phase 3: Frontend Dashboard Component (Day 3)

**Task 3.1: Create dashboard page**
- File: `/frontend/src/pages/UnitDashboard.tsx`
- Components:
  - Three statistic cards (total systems, overall %, complete systems)
  - Table with system list and progress bars
  - Loading states
  - Error handling

**Task 3.2: Add routing**
- File: `/frontend/src/App.tsx`
- Route: `/dashboard/unit`
- Protected route (require login)

**Task 3.3: Navigation menu**
- Add "Dashboard" link to main menu
- Icon: <DashboardOutlined />

**Task 3.4: API integration**
- File: `/frontend/src/services/api.ts`
- Function: `getDashboardData()`
- Handle loading/error states

**Deliverable:** Working dashboard page accessible from menu

---

### Phase 4: Tab Validation Logic (Day 4)

**Task 4.1: Frontend validation utilities**
- File: `/frontend/src/utils/formValidation.ts`
- Export required fields map matching backend
- Function: `validateTab(form, tabKey)` - returns boolean

**Task 4.2: Enhance SystemCreate.tsx**
- Add state: `tabsCompleted` (track which tabs are complete)
- Add handler: `handleTabChange()` - validate before switching
- Add visual indicators to tab labels (‚úÖ/‚ö†Ô∏è icons)
- Show error message if tab incomplete

**Task 4.3: Enhance SystemEdit.tsx**
- Mirror changes from SystemCreate.tsx
- Pre-populate `tabsCompleted` state based on existing data

**Task 4.4: "Save Draft" button**
- Allow saving without validation (partial progress)
- Different from "Submit" which requires all tabs complete

**Deliverable:** Tab validation preventing incomplete submissions

---

### Phase 5: Testing & Deployment (Day 5)

**Task 5.1: Integration testing**
- [ ] Create test organization
- [ ] Create test user for that organization
- [ ] Login as unit user
- [ ] Create incomplete system
- [ ] Verify dashboard shows correct progress
- [ ] Try to skip tabs (should be blocked)
- [ ] Complete all tabs
- [ ] Verify 100% completion on dashboard

**Task 5.2: Security testing**
- [ ] Verify unit A cannot see unit B's systems
- [ ] Verify API endpoint filters by org
- [ ] Test SQL injection attempts
- [ ] Test XSS in system names

**Task 5.3: Performance testing**
- [ ] Test with 100+ systems per org
- [ ] Check dashboard load time (< 2 seconds)
- [ ] Check progress calculation performance

**Task 5.4: Deploy to staging**
- [ ] Build frontend
- [ ] Run migrations (if any)
- [ ] Deploy backend
- [ ] Deploy frontend
- [ ] Smoke test

**Task 5.5: User acceptance testing**
- [ ] Customer demo
- [ ] Gather feedback
- [ ] Address issues

**Deliverable:** Feature deployed to production

---

## Technical Specifications

### Backend API Response Format

```json
{
  "organization": {
    "id": 1,
    "name": "V·ª• C√¥ng ngh·ªá th√¥ng tin"
  },
  "total_systems": 15,
  "overall_completion_percentage": 67.3,
  "systems": [
    {
      "id": 123,
      "system_name": "H·ªá th·ªëng qu·∫£n l√Ω vƒÉn b·∫£n",
      "system_code": "QLVB-2024-001",
      "status": "production",
      "completion_percentage": 85.2,
      "created_at": "2024-12-01T10:30:00Z",
      "updated_at": "2025-01-15T14:22:00Z"
    },
    {
      "id": 124,
      "system_name": "H·ªá th·ªëng b√°o c√°o",
      "system_code": "BC-2024-002",
      "status": "development",
      "completion_percentage": 45.0,
      "created_at": "2024-12-10T08:00:00Z",
      "updated_at": "2025-01-10T09:15:00Z"
    }
  ]
}
```

### Frontend Component Structure

```
/frontend/src/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ UnitDashboard.tsx         ‚Üê NEW
‚îÇ   ‚îú‚îÄ‚îÄ SystemCreate.tsx          ‚Üê ENHANCED (tab validation)
‚îÇ   ‚îî‚îÄ‚îÄ SystemEdit.tsx            ‚Üê ENHANCED (tab validation)
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ formValidation.ts         ‚Üê NEW
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ api.ts                    ‚Üê ADD getDashboardData()
```

---

## Success Metrics

| Metric | Target | How to Measure |
|--------|--------|---------------|
| **Tab Completion** | 90%+ users complete tabs in order | Analytics tracking |
| **Data Quality** | 80%+ systems at 100% completion | Dashboard aggregation |
| **Dashboard Load Time** | < 2 seconds with 100 systems | Performance testing |
| **Error Rate** | < 1% on form submissions | Error logs |
| **User Satisfaction** | > 4/5 stars on ease of use | User survey |

---

## Risks & Mitigation

### Risk 1: Performance with large datasets
**Impact:** High
**Probability:** Medium
**Mitigation:**
- Add pagination to systems table (50 per page)
- Add database indexes on organization FK
- Cache dashboard data for 5 minutes
- Use lazy loading for charts

### Risk 2: Complex validation logic
**Impact:** Medium
**Probability:** Medium
**Mitigation:**
- Start with simple required field validation
- Test thoroughly with edge cases
- Allow admin override if needed
- Document validation rules clearly

### Risk 3: User confusion about tab locking
**Impact:** Medium
**Probability:** High
**Mitigation:**
- Clear error messages explaining why tab is locked
- Visual indicators (disabled vs enabled tabs)
- Help tooltip: "Complete this tab to unlock next"
- "Save Draft" option for partial progress

---

## Dependencies

- ‚úÖ Django User & Organization models (already exist)
- ‚úÖ React 19 + Ant Design 6 (already installed)
- ‚úÖ API authentication (already working)
- üîÑ Backend models have all required fields
- üîÑ Frontend forms match backend fields

---

## Rollout Plan

1. **Week 1:**
   - Implement backend progress calculation
   - Implement API endpoint
   - Write tests
   - Deploy to staging

2. **Week 2:**
   - Implement frontend dashboard
   - Implement tab validation
   - Integration testing
   - Customer demo

3. **Week 3:**
   - Address feedback
   - Security testing
   - Performance optimization
   - Deploy to production

---

## Testing Checklist

### Backend Tests
- [ ] Unit test: `calculate_system_completion_percentage()` with empty system
- [ ] Unit test: `calculate_system_completion_percentage()` with partial system
- [ ] Unit test: `calculate_system_completion_percentage()` with complete system
- [ ] API test: GET /dashboard/unit-progress/ returns correct data
- [ ] API test: Org filtering works correctly
- [ ] API test: Unauthenticated user blocked

### Frontend Tests
- [ ] Dashboard loads without errors
- [ ] Statistics cards show correct numbers
- [ ] Systems table displays all systems
- [ ] Progress bars render correctly
- [ ] Tab validation prevents skipping
- [ ] Visual indicators show tab status
- [ ] Save Draft works without validation
- [ ] Submit requires all tabs complete

### Integration Tests
- [ ] End-to-end: Create system ‚Üí see on dashboard
- [ ] End-to-end: Edit system ‚Üí progress updates
- [ ] Security: Unit A cannot see Unit B data
- [ ] Performance: Dashboard loads in < 2s with 100 systems

---

## Documentation Needed

1. **User Guide:**
   - How to view dashboard
   - Understanding completion percentages
   - Tab-by-tab form filling process

2. **Admin Guide:**
   - How to create unit accounts
   - How to monitor data quality
   - How to override validation if needed

3. **Developer Guide:**
   - How progress calculation works
   - How to add new required fields
   - How tab validation logic works

---

## Future Enhancements (Out of Scope)

- Email notifications when completion < 50%
- Export dashboard data to Excel
- Historical progress charts (trend over time)
- Comparison between units (leaderboard)
- Auto-save draft every 5 minutes
- Field-level completion tracking (which fields missing)

---

**Status:** Ready for implementation
**Next Action:** Start Phase 1 - Backend Progress Calculation
**Assignee:** TBD
**Estimated Start:** 2026-01-20
**Estimated Completion:** 2026-01-27 (1 week)
