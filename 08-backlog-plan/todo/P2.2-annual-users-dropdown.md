# P2.2: Convert Annual Users to Dropdown

**Priority**: P2 (Enhancement)
**Status**: ‚è≥ TODO
**Category**: Quick Input Enhancement
**Effort**: üîß Small (1-2 hours)
**Created**: 2026-01-20

---

## User Request

> "S·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng h√†ng nƒÉm --> chuyen thanh dang dropdown voi mot so lua chon (tu de xuat) --> add vao backlog"

Translation: Annual users count ‚Üí convert to dropdown with some predefined options (suggest values)

---

## Problem

### Current State

**Field**: `annual_users` (Integer field in SystemArchitecture model)
- Located: Tab 2 (Nested in architecture_data)
- Current UI: `<InputNumber>` - free text number input
- No guidance on typical ranges

### Issue

**No Input Guidance**: Users must guess appropriate values without reference points.

**Data Inconsistency**: Wide variance in input precision:
- Some users enter: 1000 (round number)
- Some users enter: 1247 (exact count)
- Some users enter: 500000 (very large, unclear if realistic)

**No Validation**: No upper/lower bounds, can enter unrealistic values.

---

## Solution

### Recommended Approach: SelectWithOther Dropdown

**Convert to**: Dropdown with predefined common ranges + "Kh√°c" ‚Üí custom input

**Predefined Options** (based on system scale):
1. **< 1,000** - H·ªá th·ªëng nh·ªè (Small system)
2. **1,000 - 5,000** - H·ªá th·ªëng v·ª´a (Medium system)
3. **5,000 - 20,000** - H·ªá th·ªëng l·ªõn (Large system)
4. **20,000 - 100,000** - H·ªá th·ªëng r·∫•t l·ªõn (Very large system)
5. **100,000 - 500,000** - H·ªá th·ªëng quy m√¥ qu·ªëc gia (National scale)
6. **> 500,000** - H·ªá th·ªëng kh·ªïng l·ªì (Massive scale)
7. **Kh√°c** ‚Üí `<InputNumber>` for exact value

**Reasoning**:
- Most users don't know exact annual user count
- Ranges provide guidance and context
- Still allows exact input via "Kh√°c" option
- Faster data entry (select vs type numbers)
- More consistent data for reporting

---

## Implementation

### Backend Changes

**Option 1: Store range string (RECOMMENDED)**

**Model Change**: None required (CharField can store range strings)

**Migration**: None required (existing integer values preserved)

**Data Format**:
- Store range as string: "5000-20000"
- Or store midpoint integer: 12500
- Or store custom exact value: 15237

**Validation**: Update serializer to accept both integer and range string

```python
# /backend/apps/systems/serializers.py
def validate_annual_users(self, value):
    """Accept integer or range string"""
    if isinstance(value, int):
        if value < 0:
            raise serializers.ValidationError("S·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng kh√¥ng th·ªÉ √¢m.")
        return value
    elif isinstance(value, str):
        # Validate range format "1000-5000" or "> 500000" or "< 1000"
        return value
    return value
```

**Option 2: Keep as integer (SIMPLER)**

**Store midpoint** of selected range:
- "< 1,000" ‚Üí 500
- "1,000 - 5,000" ‚Üí 3000
- "5,000 - 20,000" ‚Üí 12500
- etc.

**Custom value**: Store as-is

**Benefit**: No database schema change, no migration needed

---

### Frontend Changes

**File**: `/frontend/src/pages/SystemCreate.tsx` and `SystemEdit.tsx`

**Location**: Tab 2, around line ~650 (in architecture_data section)

**Current Code**:
```tsx
<Form.Item
  name={['architecture_data', 'annual_users']}
  label="S·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng h√†ng nƒÉm"
  rules={[
    { required: true, message: 'Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng h√†ng nƒÉm' }
  ]}
>
  <InputNumber
    style={{ width: '100%' }}
    min={0}
    placeholder="e.g., 50000"
  />
</Form.Item>
```

**New Code** (using existing SelectWithOther component):
```tsx
<Form.Item
  name={['architecture_data', 'annual_users']}
  label="S·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng h√†ng nƒÉm"
  tooltip="∆Ø·ªõc t√≠nh s·ªë l∆∞·ª£t truy c·∫≠p/s·ª≠ d·ª•ng trong 1 nƒÉm"
  rules={[
    { required: true, message: 'Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p s·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng h√†ng nƒÉm' }
  ]}
>
  <SelectWithOther
    options={annualUsersOptions}
    placeholder="Ch·ªçn ph·∫°m vi ho·∫∑c nh·∫≠p s·ªë ch√≠nh x√°c"
    customInputPlaceholder="Nh·∫≠p s·ªë ch√≠nh x√°c (VD: 15000)"
    customInputType="number" // NEW PROP - render InputNumber instead of Input
  />
</Form.Item>
```

**New Options Array**:
```typescript
const annualUsersOptions = [
  { label: '< 1,000 (H·ªá th·ªëng nh·ªè)', value: '500' }, // Midpoint
  { label: '1,000 - 5,000 (H·ªá th·ªëng v·ª´a)', value: '3000' },
  { label: '5,000 - 20,000 (H·ªá th·ªëng l·ªõn)', value: '12500' },
  { label: '20,000 - 100,000 (H·ªá th·ªëng r·∫•t l·ªõn)', value: '60000' },
  { label: '100,000 - 500,000 (Quy m√¥ qu·ªëc gia)', value: '300000' },
  { label: '> 500,000 (H·ªá th·ªëng kh·ªïng l·ªì)', value: '750000' },
  { label: 'Kh√°c (Nh·∫≠p ch√≠nh x√°c)', value: 'other' },
];
```

---

### Component Enhancement

**Update SelectWithOther component** to support `customInputType` prop:

**File**: `/frontend/src/components/form/SelectWithOther.tsx`

**Add new prop**:
```typescript
interface SelectWithOtherProps {
  // ... existing props
  customInputType?: 'text' | 'number'; // NEW: default 'text'
}
```

**Render logic**:
```typescript
{showCustomInput && (
  <>
    {customInputType === 'number' ? (
      <InputNumber
        style={{ width: '100%', marginTop: 8 }}
        value={customValue}
        onChange={(val) => handleCustomInputChange(val?.toString() || '')}
        placeholder={customInputPlaceholder}
        min={0}
        autoFocus
      />
    ) : (
      <Input
        style={{ marginTop: 8 }}
        value={customValue}
        onChange={(e) => handleCustomInputChange(e.target.value)}
        placeholder={customInputPlaceholder}
        autoFocus
      />
    )}
  </>
)}
```

---

## Alternative Solutions

### Option 2: Slider Input (Not Recommended)
- Use Ant Design `<Slider>` with marks at key ranges
- **Issue**: Less precise, hard to set exact values

### Option 3: Radio Group (Not Recommended)
- Radio buttons for each range
- **Issue**: Takes more vertical space, no custom input option

---

## Testing

### Test Case 1: Select Predefined Range
1. Navigate to SystemCreate Tab 2
2. Click annual_users dropdown
3. Select "5,000 - 20,000 (H·ªá th·ªëng l·ªõn)"
4. Save
5. Expected: Value 12500 (midpoint) saved to backend

### Test Case 2: Enter Custom Value
1. Select "Kh√°c (Nh·∫≠p ch√≠nh x√°c)"
2. InputNumber appears
3. Enter 17825
4. Save
5. Expected: Value 17825 saved to backend

### Test Case 3: Edit Existing System
1. Open system with annual_users = 50000
2. Tab 2 ‚Üí annual_users field
3. Expected: Shows "20,000 - 100,000" range OR "Kh√°c" with custom value 50000
4. Change to "100,000 - 500,000"
5. Save
6. Expected: Value 300000 saved

### Test Case 4: Validation
1. Leave field empty
2. Try to save
3. Expected: Validation error "Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p..."

---

## Data Migration Strategy

### No Migration Needed (Option 2: Keep as Integer)

**Existing data**: All current integer values remain valid

**Display Logic**:
```typescript
const getDisplayValue = (value: number | null) => {
  if (value === null) return null;

  if (value < 1000) return '500';
  if (value < 5000) return '3000';
  if (value < 20000) return '12500';
  if (value < 100000) return '60000';
  if (value < 500000) return '300000';
  return '750000';
};
```

**When editing**:
- If value matches a midpoint ‚Üí show predefined option
- If value doesn't match ‚Üí show "Kh√°c" + custom value

---

## Related Files

- `/frontend/src/pages/SystemCreate.tsx` (Tab 2, ~line 650)
- `/frontend/src/pages/SystemEdit.tsx` (Tab 2, similar)
- `/frontend/src/components/form/SelectWithOther.tsx` (enhance with customInputType)
- `/backend/apps/systems/models.py` (SystemArchitecture.annual_users - no change)
- `/backend/apps/systems/serializers.py` (validation - minor update)

---

## Acceptance Criteria

- [ ] annual_users field converted to SelectWithOther dropdown
- [ ] 7 predefined options visible (6 ranges + "Kh√°c")
- [ ] Selecting range saves midpoint integer to backend
- [ ] Selecting "Kh√°c" shows InputNumber for custom input
- [ ] Custom input accepts integer values
- [ ] Validation prevents negative numbers
- [ ] Edit mode: existing values display correctly (range or custom)
- [ ] Edit mode: can switch between range and custom
- [ ] Save succeeds with both range and custom values
- [ ] TypeScript compilation successful
- [ ] No breaking changes to API

---

## Benefits

### User Experience
- ‚úÖ Faster data entry (select vs type)
- ‚úÖ Contextual guidance (system scale labels)
- ‚úÖ Consistent data input

### Data Quality
- ‚úÖ More uniform data (less variance)
- ‚úÖ Easier reporting and analytics
- ‚úÖ Realistic value ranges

### Development
- ‚úÖ Reuses existing SelectWithOther component
- ‚úÖ No database schema change
- ‚úÖ Backward compatible
- ‚úÖ Easy to enhance (add more ranges later)

---

## Future Enhancements (Optional)

1. **Dynamic Ranges**: Adjust ranges based on system_group or scope
2. **Analytics**: Show distribution chart of user ranges
3. **Validation**: Cross-validate with users_total, users_mau, users_dau fields
4. **Recommendations**: Suggest range based on organization size

---

## Estimated Time

- SelectWithOther enhancement (customInputType): 30 minutes
- Frontend changes (SystemCreate + SystemEdit): 30 minutes
- Backend validation update: 15 minutes
- Testing: 20 minutes
- Code review: 10 minutes

**Total**: ~1.5 hours
