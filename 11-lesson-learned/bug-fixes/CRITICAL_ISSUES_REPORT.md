# CRITICAL ISSUES REPORT - AI Assistant UAT

**Date**: 2026-02-05
**Status**: üî¥ BLOCKED + üî¥ NEW CRITICAL BUG

---

## Issue #1: "AI PH√ÇN T√çCH" Section Fix BLOCKED by Cloudflare CDN Cache

### Current Status
‚úÖ **Fix is DEPLOYED** in container
‚ùå **Fix is NOT LIVE** due to CDN cache

### Root Cause Analysis

1. **Frontend code is FIXED**:
   - File: `frontend/src/pages/StrategicDashboard.tsx`
   - Fixed React closure bug by capturing `completedTasks` in state callback
   - Commit: c37d406

2. **Container has CORRECT files**:
   ```bash
   $ docker compose exec frontend ls /usr/share/nginx/html/assets/
   index-npwhcm9d.js  # NEW FILE (4.5MB) - Contains fix
   worker-DEQoElfg.js
   ```

3. **Container HTML references CORRECT file**:
   ```html
   <script type="module" crossorigin src="/assets/index-npwhcm9d.js"></script>
   ```

4. **BUT Browser loads OLD file**:
   ```
   Console: hientrangcds.mindmaid.ai/assets/index-BT7jCt8r.js:750
   ```

### The Problem: **Cloudflare CDN Cache**

nginx config shows site is behind Cloudflare:
```nginx
location ~* \.(js|css)$ {
    expires -1;
    add_header Cloudflare-CDN-Cache-Control "no-cache";
    ...
}
```

Even with `"no-cache"` header, **Cloudflare is still serving cached old file**.

### Solution Required

**MUST purge Cloudflare cache** to deploy the fix:

#### Option 1: Purge via Cloudflare Dashboard (Recommended)
1. Login to Cloudflare dashboard
2. Select domain: `hientrangcds.mindmaid.ai`
3. Go to **Caching** ‚Üí **Purge Cache**
4. Choose **Purge Everything** or specific URLs:
   - `https://hientrangcds.mindmaid.ai/`
   - `https://hientrangcds.mindmaid.ai/index.html`
   - `https://hientrangcds.mindmaid.ai/assets/*`

#### Option 2: Purge via API (if credentials available)
```bash
curl -X POST "https://api.cloudflare.com/client/v4/zones/{zone_id}/purge_cache" \
  -H "Authorization: Bearer {api_token}" \
  -H "Content-Type: application/json" \
  --data '{"purge_everything":true}'
```

#### Option 3: Wait for Cache TTL
Cloudflare default cache TTL is typically 2-4 hours. Fix will auto-deploy after TTL expires.

---

## Issue #2: üî¥ NEW CRITICAL - AI Answers Are WRONG for Most Questions

### User Report
> "hien tai cac cau hoi quick question tru cau hoi co bao nhieu he thong ra thi deu tra loi sai het"
>
> Translation: "Currently all quick questions except 'how many systems' are answered incorrectly"

### User Request
> "su dung vibe test agent test het cac cau nay cho toi. Fix den khi nao tat ca cac xau deu tra loo dung"
>
> Translation: "Use vibe test agent to test all these questions for me. Fix until all answers are correct"

### Sample Questions to Test (from UI)

Quick suggestions:
1. ‚úÖ "C√≥ bao nhi√™u h·ªá th·ªëng?" - **CORRECT** (returns 87)
2. ‚ùì "H·ªá th·ªëng n√†o c·∫ßn n√¢ng c·∫•p?" - **Need to test**
3. ‚ùì "T·ªïng dung l∆∞·ª£ng CSDL?" - **Need to test**

Sample questions:
4. ‚ùì "B·ªô KH&CN hi·ªán c√≥ bao nhi√™u h·ªá th·ªëng CNTT?" - **Need to test** (should be 87)
5. ‚ùì "Top 5 h·ªá th·ªëng t·ªën k√©m nh·∫•t?" - **Need to test**
6. ‚ùì "ƒê∆°n v·ªã n√†o c√≥ nhi·ªÅu h·ªá th·ªëng nh·∫•t?" - **Need to test**
7. ‚ùì "H·ªá th·ªëng n√†o h·∫øt h·∫°n b·∫£o m·∫≠t?" - **Need to test**

### Next Steps

1. **Create comprehensive test script** to test ALL sample questions
2. **Capture actual vs expected results** for each question
3. **Analyze AI prompts** to identify why answers are wrong
4. **Fix prompts/logic** iteratively until all answers correct
5. **Deploy fixes** (will need Cloudflare cache purge again)

### Test Automation Plan

Use Playwright automation to:
- Submit each sample question via API
- Capture AI response
- Verify answer correctness
- Generate detailed test report with failures

---

## Priority Actions

### Immediate (Now)
1. ‚úÖ **Report created** - Documented both issues
2. üîÑ **Contact Cloudflare admin** to purge cache (Issue #1)
3. üîÑ **Start comprehensive AI testing** (Issue #2)

### Short-term (After cache purge)
1. Verify "AI PH√ÇN T√çCH" section fix works
2. Fix all wrong AI answers
3. Purge cache again after AI fixes
4. Final UAT verification

---

## Files Modified (Issue #1 - Already deployed)

- `backend/apps/systems/views.py` - Added `_get_critical_context()` with CRITICAL RULE
- `frontend/src/pages/StrategicDashboard.tsx` - Fixed closure bug (line ~900)

## Files to Check (Issue #2 - Pending)

- `backend/apps/systems/views.py` - AI prompts for Quick mode
- Database queries being generated by AI
- System prompt engineering

---

## Test Script Location

Will create automated test script at:
```
/tmp/ai-assistant-comprehensive-test.sh
```

This will test all sample questions and generate detailed failure report.
