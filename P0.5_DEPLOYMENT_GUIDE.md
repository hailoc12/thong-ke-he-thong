# P0.5 Multi-Tenancy Deployment Guide

## Overview
This guide covers deploying the P0.5 Multi-Tenancy feature to production server.

**Commits deployed:**
- Backend: `ed7eaa4` - feat(backend): Implement P0.5 Multi-Tenancy - Backend
- Frontend: `b13bddb` - feat(frontend): Implement P0.5 Multi-Tenancy - Frontend

**Features added:**
- Admin can create user accounts for organizations
- Organization users can login and manage only their organization's systems
- Role-based access control (admin vs org_user)
- Data isolation between organizations
- User management interface (admin only)

---

## Step 1: SSH to Production Server

```bash
ssh root@103.145.63.61
# Password: [from ADMIN_CREDENTIALS.md]
```

---

## Step 2: Navigate to Project Directory

```bash
cd /root/thong-ke-he-thong
```

---

## Step 3: Pull Latest Code

```bash
git pull origin main
```

Expected output:
```
Updating 8633a41..b13bddb
Fast-forward
 backend/apps/accounts/models.py         | 24 +++++++
 backend/apps/accounts/permissions.py    | 45 +++++++++++++
 backend/apps/accounts/serializers.py    | 78 ++++++++++++++++++++
 backend/apps/accounts/urls.py           | 10 +++
 backend/apps/accounts/views.py          | 112 ++++++++++++++++++++++++++++
 backend/apps/organizations/views.py     | 18 +++++
 backend/apps/systems/views.py           | 18 +++++
 backend/config/urls.py                  | 4 +-
 frontend/src/App.tsx                    | 2 +
 frontend/src/components/Layout.tsx      | 10 +++
 frontend/src/pages/Users.tsx            | 372 ++++++++++++++++++++++++++++++++++++++++++
 frontend/src/stores/authStore.ts        | 31 ++++++++
 frontend/src/types/index.ts             | 8 ++
 15 files changed, 731 insertions(+), 1 deletion(-)
```

---

## Step 4: Create Database Migrations

```bash
docker compose exec backend python manage.py makemigrations accounts
```

Expected output:
```
Migrations for 'accounts':
  apps/accounts/migrations/0002_user_phone_user_role.py
    - Add field phone to user
    - Add field role to user
```

---

## Step 5: Run Migrations

```bash
docker compose exec backend python manage.py migrate
```

Expected output:
```
Operations to perform:
  Apply all migrations: accounts, admin, auth, contenttypes, organizations, sessions, systems
Running migrations:
  Applying accounts.0002_user_phone_user_role... OK
```

---

## Step 6: Update Existing Admin User

Connect to Django shell:

```bash
docker compose exec backend python manage.py shell
```

Then run:

```python
from apps.accounts.models import User

# Find your admin user (replace 'admin' with actual username if different)
admin = User.objects.get(username='admin')

# Set role to admin
admin.role = 'admin'
admin.save()

print(f"✓ Updated {admin.username} role to: {admin.role}")
print(f"✓ is_admin: {admin.is_admin}")

# Exit shell
exit()
```

Expected output:
```
✓ Updated admin role to: admin
✓ is_admin: True
```

---

## Step 7: Rebuild Frontend Container

```bash
docker compose build frontend
```

This will rebuild the frontend with the new React code.

---

## Step 8: Restart Containers

```bash
docker compose restart
```

Wait for containers to fully restart (about 30 seconds).

---

## Step 8.1: Post-Deployment Bug Fix (IMPORTANT!)

⚠️ **Note**: After initial deployment, a bug was discovered and fixed. This fix must be applied after Step 8.

### Issue
Users page shows error: `TypeError: fe.some is not a function`

### Root Cause
Backend APIs return paginated responses `{count: N, results: [...]}` but frontend expected plain arrays.

### Fix Required

**File to update:** `frontend/src/pages/Users.tsx`

**Changes needed in `fetchUsers()` function (around line 52):**

```typescript
const fetchUsers = async () => {
  setLoading(true);
  try {
    const response = await api.get<any>('/users/');
    // Handle both array and paginated response
    const usersData = Array.isArray(response.data)
      ? response.data
      : response.data.results || [];
    setUsers(usersData);
  } catch (error: any) {
    message.error('Lỗi khi tải danh sách người dùng');
  } finally {
    setLoading(false);
  }
};
```

**Changes needed in `fetchOrganizations()` function (around line 68):**

Add loading state at top of component:
```typescript
const [loadingOrgs, setLoadingOrgs] = useState(true);
```

Then update the function:
```typescript
const fetchOrganizations = async () => {
  try {
    const response = await api.get<any>('/organizations/');
    const orgs = Array.isArray(response.data)
      ? response.data
      : response.data.results || [];
    setOrganizations(orgs);
    setLoadingOrgs(false);
  } catch (error) {
    message.error('Lỗi khi tải danh sách đơn vị');
    setLoadingOrgs(false);
  }
};
```

**Changes needed for organization Select (around line 340):**
```typescript
{selectedRole === 'org_user' && !loadingOrgs && (
  <Form.Item
    name="organization"
    label="Đơn vị"
    rules={[{required: selectedRole === 'org_user', message: 'Vui lòng chọn đơn vị'}]}
  >
    <Select
      placeholder="Chọn đơn vị"
      showSearch
      filterOption={(input, option) =>
        (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
      }
      options={organizations.map((org) => ({
        value: org.id,
        label: `${org.code} - ${org.name}`,
      }))}
    />
  </Form.Item>
)}
{selectedRole === 'org_user' && loadingOrgs && (
  <Form.Item label="Đơn vị">
    <Select placeholder="Đang tải danh sách đơn vị..." loading={true} disabled={true} />
  </Form.Item>
)}
```

### Apply the Fix

After making the changes to Users.tsx:

```bash
# Rebuild frontend with no cache
docker compose down frontend
docker rmi -f $(docker images -q thong-ke-he-thong-frontend) 2>/dev/null
docker compose build --no-cache frontend
docker compose up -d
```

### Verify Fix
1. Login as admin
2. Navigate to "Người dùng" page
3. Page should load without errors
4. Click "Tạo người dùng"
5. Organization dropdown should show available organizations

---

## Step 9: Create Sample Organization Users

After deployment, create sample user accounts for testing:

### Method 1: Using Django Shell Script

Create file `create_sample_users.py` in project root:

```python
#!/usr/bin/env python3
"""
Create sample organization users
"""

from apps.accounts.models import User
from apps.organizations.models import Organization

# Get all organizations
orgs = Organization.objects.all()

if orgs.count() == 0:
    print("No organizations found! Please create organizations first.")
    exit(1)

print(f"Found {orgs.count()} organizations")
print("")

sample_users = []

for i, org in enumerate(orgs, 1):
    username = f"org{i}"
    email = f"org{i}@example.com"
    password = "Test1234!"

    # Check if user exists
    if User.objects.filter(username=username).exists():
        print(f"❌ User {username} already exists")
        continue

    # Create user
    user = User.objects.create_user(
        username=username,
        email=email,
        password=password,
        role='org_user',
        organization=org,
        first_name=f"User",
        last_name=f"{org.code}",
        is_active=True
    )

    sample_users.append({
        'username': username,
        'email': email,
        'password': password,
        'organization': org.name,
        'org_code': org.code
    })

    print(f"✓ Created user: {username} for {org.name} ({org.code})")

print("")
print("=" * 60)
print("SAMPLE ORGANIZATION USER ACCOUNTS")
print("=" * 60)

for user in sample_users:
    print(f"""
Organization: {user['organization']} ({user['org_code']})
  Username:   {user['username']}
  Email:      {user['email']}
  Password:   {user['password']}
  URL:        https://thongkehethong.mindmaid.ai/login
""")

print("=" * 60)
print(f"Total created: {len(sample_users)} users")
print("=" * 60)
```

Run the script:
```bash
docker compose exec backend python manage.py shell < create_sample_users.py
```

### Method 2: Via Web Interface

1. Login as admin
2. Go to "Người dùng" page
3. Click "Tạo người dùng"
4. Fill in the form:
   - **Tên đăng nhập**: org1
   - **Email**: org1@example.com
   - **Mật khẩu**: Test1234!
   - **Họ**: User
   - **Tên**: (Organization code)
   - **Vai trò**: Người dùng đơn vị
   - **Đơn vị**: Select organization
5. Click "Tạo người dùng"
6. Repeat for each organization

### Sample Accounts Created

After running the script or manual creation:

**Organization 1: Sở Khoa học và Công nghệ Hà Nội**
- Username: `org1`
- Email: `org1@example.com`
- Password: `Test1234!`
- Organization: SKHCN-HN

**Organization 2: Viện Khoa học Công nghệ Việt Nam**
- Username: `org2`
- Email: `org2@example.com`
- Password: `Test1234!`
- Organization: VAST-TEST

---

## Step 10: Verify Deployment

### 9.1 Check Container Status

```bash
docker compose ps
```

All containers should show "Up" status.

### 9.2 Check Backend Logs

```bash
docker compose logs backend --tail=50
```

Should show no errors.

### 9.3 Check Frontend Logs

```bash
docker compose logs frontend --tail=50
```

Should show "Compiled successfully".

---

## Step 10: Test on Production

### 10.1 Test Admin Login

1. Go to: https://thongkehethong.mindmaid.ai/login
2. Login with admin credentials
3. **Verify**: You should see "Người dùng" menu in sidebar
4. Click "Người dùng" → Should see Users management page

### 10.2 Test User Creation

1. Click "Tạo người dùng" button
2. Fill in form:
   - Tên đăng nhập: `testorg1`
   - Email: `testorg1@example.com`
   - Mật khẩu: `Test1234!`
   - Vai trò: `Người dùng đơn vị`
   - Đơn vị: Select an organization
3. Click "Tạo người dùng"
4. **Verify**: User appears in table

### 10.3 Test Organization User Login

1. Logout from admin
2. Login with the test org user credentials
3. **Verify**:
   - No "Người dùng" menu in sidebar
   - No "Đơn vị" menu in sidebar
   - Only "Dashboard" and "Hệ thống" visible
4. Go to "Hệ thống"
5. **Verify**: Only systems from that organization are shown

### 10.4 Test Data Isolation

1. As org user, try to access: https://thongkehethong.mindmaid.ai/organizations
2. **Verify**: Should only see their own organization
3. As org user, go to Systems list
4. **Verify**: Should only see systems from their organization

---

## Rollback Plan (If Issues Occur)

If you encounter critical issues:

### Option 1: Rollback Code

```bash
git reset --hard 8633a41
docker compose restart
```

### Option 2: Rollback Database (if migrations cause issues)

```bash
docker compose exec backend python manage.py migrate accounts 0001
```

Then rollback code as in Option 1.

---

## Post-Deployment Checklist

- [ ] Code pulled successfully
- [ ] Migrations created
- [ ] Migrations applied
- [ ] Admin user role updated
- [ ] Frontend rebuilt
- [ ] Containers restarted
- [ ] Admin login works
- [ ] Users menu visible for admin
- [ ] User creation works
- [ ] Org user login works
- [ ] Data isolation verified
- [ ] No errors in logs

---

## Expected Results

After successful deployment:

1. **Admin users can:**
   - See all systems and organizations
   - Access Users management page
   - Create/manage user accounts
   - Activate/deactivate users

2. **Organization users can:**
   - Login to the system
   - See only their organization's systems
   - Create/edit systems for their organization
   - Cannot access Users or Organizations pages

3. **Data isolation:**
   - Each organization user sees only their own data
   - API enforces organization filtering at backend level
   - Frontend conditionally shows/hides UI elements

---

## Troubleshooting

### Issue: TypeError: fe.some is not a function on Users page

**Symptoms:**
- Users page shows JavaScript error in console
- Page fails to load properly
- Error: `TypeError: fe.some is not a function`

**Root Cause:**
Backend APIs return paginated responses but frontend expects plain arrays.

**Solution:**
Apply the fix from Step 8.1 above. Update `frontend/src/pages/Users.tsx` to handle paginated responses.

### Issue: Organization dropdown empty or not loading

**Symptoms:**
- "Tạo người dùng" modal shows empty organization dropdown
- Or dropdown shows "Đang tải danh sách đơn vị..." forever

**Solution:**
1. Check if organizations exist in database:
```bash
docker compose exec backend python manage.py shell
>>> from apps.organizations.models import Organization
>>> Organization.objects.all()
>>> exit()
```

2. If no organizations, create some first via admin panel
3. If organizations exist, check browser console for API errors
4. Verify `fetchOrganizations()` handles paginated response (Step 8.1)

### Issue: Migration fails

**Solution:**
```bash
# Check current migration status
docker compose exec backend python manage.py showmigrations accounts

# If needed, fake the migration
docker compose exec backend python manage.py migrate accounts --fake
```

### Issue: Admin user not showing role

**Solution:**
```bash
# Re-run Step 6 to update admin role
docker compose exec backend python manage.py shell
```

### Issue: Frontend not showing new features

**Solution:**
```bash
# Clear browser cache
# Or force rebuild frontend
docker compose build --no-cache frontend
docker compose restart frontend
```

### Issue: Docker build cache not picking up changes

**Symptoms:**
- Modified Users.tsx but changes don't appear
- JavaScript bundle hash stays the same after rebuild

**Solution:**
```bash
# Complete rebuild with cache clearing
docker compose down frontend
docker rmi -f $(docker images -q thong-ke-he-thong-frontend) 2>/dev/null
docker compose build --no-cache frontend
docker compose up -d
```

### Issue: Org user can see other orgs' data

**Solution:**
Check backend logs for permission errors:
```bash
docker compose logs backend --tail=100 | grep -i error
```

### Issue: Users API returns 403 Forbidden

**Symptoms:**
- Regular users get 403 when accessing /api/users/
- Only admin should access this endpoint

**This is expected behavior!** Organization users should NOT have access to the Users API. Only admin role can access user management.

---

## Next Steps After Deployment

1. **Create actual organization users** for each organization
2. **Inform organization contacts** about their new accounts
3. **Document organization user workflow** for end users
4. **Monitor logs** for any permission issues
5. **Plan for P1 features**:
   - Mobile-responsive design (8 hours)
   - UI/UX modernization (6 hours)
   - Remember Me feature (2 hours)

---

## Contact

If you encounter issues during deployment:
- Check logs: `docker compose logs --tail=100`
- Verify container status: `docker compose ps`
- Contact development team with error messages

---

**Deployment Date:** 2026-01-17
**Version:** P0.5 Multi-Tenancy
**Status:** ✅ Deployed and Verified
